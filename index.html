<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¬Ù„ÙˆØ³ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body { font-family: 'Cairo', sans-serif; }
        .step-section { display: none; }
        .step-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .seat { transition: all 0.2s ease-in-out; }
        .seat.disabled { background-color: #4b5563 !important; border-color: #1f2937 !important; cursor: not-allowed; }
        .seat.disabled::after { content: 'âœ•'; color: white; font-size: 1.5rem; display: flex; justify-content: center; align-items: center; height: 100%; }
        .seat.occupied { background-color: #e0f2fe; border-color: #0284c7; }
        
        #hall-modal-backdrop, #preview-modal-backdrop { background-color: rgba(0,0,0,0.5); }
        
        /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø§Øª QR Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        #qr-cards-container {
            width: 210mm;
            background: white;
            position: absolute;
            left: -9999px;
            top: 0;
            padding: 10mm;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5mm;
        }
        .student-qr-card {
            width: 60mm;
            height: 25mm;
            border: 1px solid #000;
            padding: 2mm;
            display: flex;
            flex-direction: row-reverse;
            align-items: center;
            justify-content: space-between;
            box-sizing: border-box;
            background: #fff;
        }
        .card-info {
            flex: 1;
            text-align: right;
            font-size: 8pt;
            line-height: 1.2;
            padding-right: 2mm;
            font-weight: bold;
        }
        .card-qr-box {
            width: 20mm;
            height: 20mm;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card-qr-box img {
            width: 20mm; /* ØªÙ… Ø¬Ø¹Ù„Ù‡ Ù…Ø±Ø¨Ø¹Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŒ Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ù‚Ø¯ ÙŠÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø³Ø­ */
            height: 20mm;
        }

        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="bg-stone-50 text-slate-800">

    <div id="login-screen" class="fixed inset-0 bg-stone-100 z-50 flex flex-col items-center justify-center">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg border border-slate-200">
            <h1 class="text-3xl font-bold text-sky-700 mb-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¬Ù„ÙˆØ³</h1>
            <p class="text-slate-500 mb-6">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <button id="login-btn" class="bg-white text-slate-700 border border-slate-300 font-bold py-3 px-8 rounded-lg hover:bg-slate-50 transition flex items-center gap-3 shadow-sm">
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</span>
            </button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            
            <header class="text-center mb-8 border-b pb-4 relative">
                <div id="auth-info" class="w-full flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div id="welcome-message" class="text-sm font-bold text-sky-800 bg-sky-50 px-4 py-2 rounded-lg border border-sky-100"></div>
                    <div class="flex flex-wrap items-center justify-center gap-3">
                        <button id="logout-btn" class="action-btn bg-slate-600 text-white hover:bg-slate-700">Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-sky-700">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¬Ù„ÙˆØ³ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØ©</h1>
            </header>

            <div id="stepper" class="flex justify-center items-center mb-10 space-x-4 md:space-x-8 rtl:space-x-reverse"></div>

            <main class="bg-white rounded-xl shadow-lg p-6 md:p-8 min-h-[500px]">
                
                <section id="step-1" class="step-section active">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØ©</h2>
                    </div>
                    <div class="mb-6 text-center">
                        <button id="show-hall-modal-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-md hover:bg-sky-700 transition shadow-md">+ Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    </div>
                    <div id="halls-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>

                <section id="step-2" class="step-section">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                    </div>
                    <textarea id="students-text" rows="8" class="w-full p-2 border rounded-md" placeholder="Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØŒ Ø§Ù„ØµÙØŒ Ø§Ù„Ø´Ø¹Ø¨Ø©"></textarea>
                    <button id="import-text-btn" class="mt-2 w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-md hover:bg-sky-700 transition">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                    <div id="student-list" class="mt-4 max-h-40 overflow-y-auto"></div>
                </section>

                <section id="step-3" class="step-section">
                    <div class="text-center mb-8"><h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„ØªÙˆØ²ÙŠØ¹</h2></div>
                    <div id="unassigned-students" class="mb-4"></div>
                    <button id="auto-distribute-btn" class="bg-emerald-600 text-white py-2 px-4 rounded">ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                    <div id="multi-hall-distribution-container" class="mt-4"></div>
                </section>

                <section id="step-4" class="step-section">
                    <div class="text-center mb-8"><h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ù„ØªØµØ¯ÙŠØ±</h2></div>
                    <button id="export-chart-pdf-btn" class="bg-sky-600 text-white py-2 px-4 rounded">ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø®Ø·Ø· PDF</button>
                </section>

                <section id="step-5" class="step-section">
                    <div class="text-center mb-8"><h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„ØºÙŠØ§Ø¨</h2></div>
                    <div id="reader"></div>
                    <div id="absent-list"></div>
                </section>

                <section id="step-6" class="step-section">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-sky-700">Ø§Ù„Ø®Ø·ÙˆØ© 6: ØªØµØ¯ÙŠØ± Ø¨Ø·Ø§Ù‚Ø§Øª QR Ù„Ù„Ø·Ù„Ø§Ø¨</h2>
                        <p class="text-slate-500 mt-1">ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø§Øª ØªØ¹Ø±ÙŠÙÙŠØ© Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ (30 Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©).</p>
                    </div>
                    <div class="max-w-2xl mx-auto bg-blue-50 p-8 rounded-xl border border-blue-200 text-center">
                        <div class="mb-6 text-sky-800">
                            <ul class="text-right inline-block list-disc space-y-2">
                                <li>ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ: 3 Ø£Ø¹Ù…Ø¯Ø© Ã— 10 ØµÙÙˆÙ.</li>
                                <li>ÙƒÙ„ Ù…Ø³ØªØ·ÙŠÙ„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„Ø±Ù…Ø².</li>
                                <li>ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 30 Ø·Ø§Ù„Ø¨Ø§Ù‹.</li>
                            </ul>
                        </div>
                        <button id="export-qr-cards-btn" class="bg-sky-600 text-white font-bold py-4 px-10 rounded-lg hover:bg-sky-700 transition shadow-lg flex items-center justify-center gap-3 mx-auto">
                            <span>ğŸ–¨ï¸</span> ØªØµØ¯ÙŠØ± Ø¨Ø·Ø§Ù‚Ø§Øª QR Ù„Ù„Ø·Ù„Ø§Ø¨ (PDF)
                        </button>
                    </div>
                </section>

                <div id="navigation-btns" class="mt-10 flex justify-between border-t pt-6">
                    <button id="prev-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-md hover:bg-gray-300 transition" disabled>Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button id="next-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-md hover:bg-sky-700 transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
            </main>
        </div>
    </div>

    <div id="qr-cards-container"></div>

    <div id="progress-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-80">
            <h3 id="progress-title" class="text-lg font-bold mb-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</h3>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%;"></div>
            </div>
            <p id="progress-text" class="text-sm">0%</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù…Ø¨Ø³Ø·Ø© (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
            const firebaseConfig = { apiKey: "AIzaSy...", authDomain: "...", projectId: "..." };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();

            // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù†Ø¸Ø§Ù…
            let state = {
                currentStep: 1,
                halls: [],
                students: [],
                seatingChart: new Map(),
            };

            // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ø³Ø§Ø¯Ø³Ø©
            const steps = [
                { number: 1, label: 'Ø§Ù„Ù‚Ø§Ø¹Ø§Øª', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16' },
                { number: 2, label: 'Ø§Ù„Ø·Ù„Ø§Ø¨', icon: 'M12 4.354a4 4 0 110 5.292' },
                { number: 3, label: 'Ø§Ù„ØªÙˆØ²ÙŠØ¹', icon: 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2' },
                { number: 4, label: 'Ø§Ù„ØªØµØ¯ÙŠØ±', icon: 'M4 16v1a3 3 0 003 3h10' },
                { number: 5, label: 'Ø§Ù„ØºÙŠØ§Ø¨', icon: 'M9 5H7a2 2 0 00-2 2v12' },
                { number: 6, label: 'Ø¨Ø·Ø§Ù‚Ø§Øª QR', icon: 'M12 4v1m6 11h2m-6 0h-2v4' }
            ];

            // ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ§Øª
            const updateUI = () => {
                document.querySelectorAll('.step-section').forEach((s, i) => {
                    s.classList.toggle('active', i + 1 === state.currentStep);
                });
                document.getElementById('prev-btn').disabled = state.currentStep === 1;
                document.getElementById('next-btn').textContent = state.currentStep === steps.length ? 'Ø¥Ù†Ù‡Ø§Ø¡' : 'Ø§Ù„ØªØ§Ù„ÙŠ';
                renderStepper();
            };

            const renderStepper = () => {
                const stepper = document.getElementById('stepper');
                stepper.innerHTML = steps.map(s => `
                    <div class="flex flex-col items-center">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${s.number <= state.currentStep ? 'bg-sky-600 text-white' : 'bg-gray-200 text-gray-500'}">
                            ${s.number}
                        </div>
                        <span class="text-xs mt-1 font-bold">${s.label}</span>
                    </div>
                `).join('<div class="h-px w-8 bg-gray-300 mb-5"></div>');
            };

            // --- ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± Ø¨Ø·Ø§Ù‚Ø§Øª QR ---
            const exportQRCards = async () => {
                if (state.students.length === 0) {
                    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ†.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const container = document.getElementById('qr-cards-container');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                document.getElementById('progress-modal').classList.remove('hidden');

                const studentsPerPage = 30;
                const totalPages = Math.ceil(state.students.length / studentsPerPage);

                for (let p = 0; p < totalPages; p++) {
                    container.innerHTML = '';
                    const pageStudents = state.students.slice(p * studentsPerPage, (p + 1) * studentsPerPage);

                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø®ÙÙŠØ©
                    for (const student of pageStudents) {
                        const card = document.createElement('div');
                        card.className = 'student-qr-card';
                        
                        const qrBox = document.createElement('div');
                        qrBox.className = 'card-qr-box';
                        new QRCode(qrBox, { text: student.examId, width: 80, height: 80 });

                        card.innerHTML = `
                            <div class="card-info">
                                <div>Ø§Ù„Ø§Ø³Ù…: ${student.name}</div>
                                <div>Ø§Ù„ØµÙ: ${student.grade}</div>
                                <div>Ø§Ù„Ø´Ø¹Ø¨Ø©: ${student.section}</div>
                                <div>Ø§Ù„Ø±Ù‚Ù…: ${student.examId}</div>
                            </div>
                        `;
                        card.prepend(qrBox);
                        container.appendChild(card);
                    }

                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¥Ù„Ù‰ ØµÙˆØ±Ø© Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ù€ PDF Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø±Ø¨ÙŠ
                    await new Promise(resolve => setTimeout(resolve, 500)); // ÙˆÙ‚Øª Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ QR
                    const canvas = await html2canvas(container, { scale: 2 });
                    const imgData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    if (p > 0) pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);

                    const progress = Math.round(((p + 1) / totalPages) * 100);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                }

                pdf.save('Ø¨Ø·Ø§Ù‚Ø§Øª_QR_Ø§Ù„Ø·Ù„Ø§Ø¨.pdf');
                document.getElementById('progress-modal').classList.add('hidden');
            };

            // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            document.getElementById('export-qr-cards-btn').addEventListener('click', exportQRCards);
            document.getElementById('next-btn').addEventListener('click', () => {
                if (state.currentStep < steps.length) { state.currentStep++; updateUI(); }
            });
            document.getElementById('prev-btn').addEventListener('click', () => {
                if (state.currentStep > 1) { state.currentStep--; updateUI(); }
            });

            // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø³ÙŠØ· Ù„Ù„Ø·Ù„Ø§Ø¨ (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
            document.getElementById('import-text-btn').addEventListener('click', () => {
                const text = document.getElementById('students-text').value;
                state.students = text.split('\n').filter(l => l.trim()).map(l => {
                    const [name, examId, grade, section] = l.split('ØŒ').map(s => s.trim());
                    return { name, examId, grade, section };
                });
                alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${state.students.length} Ø·Ø§Ù„Ø¨.`);
            });

            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('welcome-message').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.displayName}`;
                    updateUI();
                }
            });

            document.getElementById('login-btn').addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider);
            });
        });
    </script>
</body>
</html>
