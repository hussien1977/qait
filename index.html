<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مخططات الجلوس الامتحانية الذكي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .step-active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .step-inactive { background-color: white; color: #6b7280; border-color: #e5e7eb; }
        .seat { transition: all 0.2s; }
        .seat:hover { transform: scale(1.05); }
        .drag-active { border: 2px dashed #2563eb; background-color: #eff6ff; }
        
        /* تنسيق الطباعة */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white; }
            .page-break { page-break-after: always; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white shadow-sm sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
                <h1 class="text-xl font-bold text-gray-900">نظام إدارة الامتحانات</h1>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full" id="current-date"></span>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8 no-print">
            <div class="flex items-center justify-center">
                <div class="flex items-center w-full max-w-4xl">
                    <div id="steps-container" class="flex w-full items-center"></div>
                </div>
            </div>
        </div>

        <div id="custom-alert" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg" role="alert">
            <p class="font-bold">تنبيه</p>
            <p id="alert-message"></p>
        </div>

        <div id="step-content" class="bg-white rounded-xl shadow-lg p-6 min-h-[500px]">
            </div>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <button id="prev-btn" class="px-6 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                السابق
            </button>
            <div class="flex gap-3">
                <button id="save-btn" class="hidden px-6 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                    حفظ البيانات
                </button>
                <button id="next-btn" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg shadow-blue-600/30">
                    التالي
                </button>
            </div>
        </div>
    </footer>

    <template id="hall-card-template">
        <div class="hall-card group relative bg-white border rounded-xl p-5 hover:shadow-md transition-all cursor-pointer">
            <div class="absolute top-3 left-3 opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="delete-hall text-red-400 hover:text-red-600 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
            </div>
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-blue-50 rounded-lg group-hover:bg-blue-100 transition-colors">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                </div>
                <span class="hall-capacity text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-1 rounded"></span>
            </div>
            <h3 class="hall-name font-bold text-lg text-gray-900 mb-1"></h3>
            <p class="text-sm text-gray-500 mb-4">صفوف: <span class="hall-rows"></span> | أعمدة: <span class="hall-cols"></span></p>
            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-2">
                <div class="hall-progress bg-blue-600 h-1.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-500">
                <span>المشغول: <span class="hall-occupied">0</span></span>
                <span>المتاح: <span class="hall-available">0</span></span>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State Management
            const state = {
                currentStep: 1,
                halls: [],
                students: [],
                distribution: [],
                selectedHallIds: new Set(),
                draggedStudent: null,
                searchQuery: '',
                scannedStudents: new Set() // New: Track scanned student IDs
            };

            const steps = [
                { id: 1, title: 'إعداد القاعات', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
                { id: 2, title: 'بيانات الطلبة', icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z' },
                { id: 3, title: 'التوزيع الآلي', icon: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' },
                { id: 4, title: 'التعديل اليدوي', icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z' },
                { id: 5, title: 'المراقبة والطباعة', icon: 'M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z' }
            ];

            // DOM Elements
            const stepsContainer = document.getElementById('steps-container');
            const stepContent = document.getElementById('step-content');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const currentDateEl = document.getElementById('current-date');

            // Initialization
            currentDateEl.textContent = new Date().toLocaleDateString('ar-IQ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Scanner Variables
            let html5QrCode = null;

            // --- UI Rendering Functions ---

            const renderSteps = () => {
                stepsContainer.innerHTML = steps.map((step, index) => {
                    const isActive = step.id === state.currentStep;
                    const isCompleted = step.id < state.currentStep;
                    
                    return `
                        <div class="flex items-center ${index !== steps.length - 1 ? 'flex-1' : ''}">
                            <div class="flex flex-col items-center relative">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 z-10 
                                    ${isActive ? 'bg-blue-600 border-blue-600 text-white' : 
                                      isCompleted ? 'bg-green-500 border-green-500 text-white' : 
                                      'bg-white border-gray-300 text-gray-400'} transition-all duration-300">
                                    ${isCompleted ? 
                                        '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' :
                                        `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${step.icon}"/></svg>`
                                    }
                                </div>
                                <span class="absolute top-12 text-xs font-semibold whitespace-nowrap ${isActive ? 'text-blue-600' : 'text-gray-500'}">
                                    ${step.title}
                                </span>
                            </div>
                            ${index !== steps.length - 1 ? 
                                `<div class="flex-1 h-1 mx-4 ${isCompleted ? 'bg-green-500' : 'bg-gray-200'} rounded"></div>` : 
                                ''}
                        </div>
                    `;
                }).join('');
            };

            const updateUI = () => {
                renderSteps();
                renderStepContent();
                
                prevBtn.disabled = state.currentStep === 1;
                nextBtn.textContent = state.currentStep === steps.length ? 'إنهاء' : 'التالي';
                
                // Save logic if needed
                if(state.currentStep === 4) {
                   document.getElementById('save-btn').classList.remove('hidden');
                } else {
                   document.getElementById('save-btn').classList.add('hidden');
                }
            };

            const renderStepContent = () => {
                stepContent.innerHTML = '';
                switch(state.currentStep) {
                    case 1: renderStep1(); break;
                    case 2: renderStep2(); break;
                    case 3: renderStep3(); break;
                    case 4: renderStep4(); break;
                    case 5: renderStep5(); break;
                }
            };

            // --- Step 1: Hall Management ---
            const renderStep1 = () => {
                stepContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800">إدارة القاعات الامتحانية</h2>
                            <button onclick="document.getElementById('add-hall-modal').classList.remove('hidden')" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                إضافة قاعة
                            </button>
                        </div>
                        
                        <div id="halls-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            </div>
                    </div>

                    <div id="add-hall-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                            <h3 class="text-xl font-bold mb-4">إضافة قاعة جديدة</h3>
                            <form id="add-hall-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">اسم القاعة</label>
                                    <input type="text" name="name" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">عدد الصفوف</label>
                                        <input type="number" name="rows" min="1" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">عدد الأعمدة</label>
                                        <input type="number" name="cols" min="1" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div class="flex justify-end gap-3 mt-6">
                                    <button type="button" onclick="document.getElementById('add-hall-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">إلغاء</button>
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">إضافة</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;

                renderHallsGrid();
                
                document.getElementById('add-hall-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const newHall = {
                        id: Date.now().toString(),
                        name: formData.get('name'),
                        rows: parseInt(formData.get('rows')),
                        cols: parseInt(formData.get('cols')),
                        capacity: parseInt(formData.get('rows')) * parseInt(formData.get('cols'))
                    };
                    state.halls.push(newHall);
                    state.selectedHallIds.add(newHall.id);
                    document.getElementById('add-hall-modal').classList.add('hidden');
                    e.target.reset();
                    renderHallsGrid();
                });
            };

            const renderHallsGrid = () => {
                const grid = document.getElementById('halls-grid');
                if(!grid) return;
                
                grid.innerHTML = state.halls.map(hall => {
                    const occupied = state.distribution.filter(s => s.hallId === hall.id).length;
                    const percent = (occupied / hall.capacity) * 100;
                    
                    return `
                    <div class="hall-card group relative bg-white border-2 ${state.selectedHallIds.has(hall.id) ? 'border-blue-500 ring-1 ring-blue-500' : 'border-gray-200'} rounded-xl p-5 hover:shadow-md transition-all cursor-pointer" 
                         onclick="toggleHallSelection('${hall.id}')">
                        <div class="absolute top-3 left-3 z-10">
                            <button onclick="deleteHall('${hall.id}', event)" class="text-red-400 hover:text-red-600 p-1 bg-white rounded-full shadow-sm hover:shadow">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 ${state.selectedHallIds.has(hall.id) ? 'bg-blue-100' : 'bg-gray-100'} rounded-lg transition-colors">
                                <svg class="w-6 h-6 ${state.selectedHallIds.has(hall.id) ? 'text-blue-600' : 'text-gray-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                            </div>
                            <span class="text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-1 rounded">السعة: ${hall.capacity}</span>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 mb-1">${hall.name}</h3>
                        <p class="text-sm text-gray-500 mb-4">${hall.rows} صفوف × ${hall.cols} أعمدة</p>
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mb-2">
                            <div class="bg-blue-600 h-1.5 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>المشغول: ${occupied}</span>
                            <span>المتاح: ${hall.capacity - occupied}</span>
                        </div>
                    </div>`;
                }).join('') || '<div class="col-span-full text-center py-12 text-gray-500 border-2 border-dashed border-gray-200 rounded-xl">لا توجد قاعات مضافة بعد</div>';
            };

            window.toggleHallSelection = (id) => {
                if(state.selectedHallIds.has(id)) {
                    state.selectedHallIds.delete(id);
                } else {
                    state.selectedHallIds.add(id);
                }
                renderHallsGrid();
            };

            window.deleteHall = (id, e) => {
                e.stopPropagation();
                if(confirm('هل أنت متأكد من حذف هذه القاعة؟')) {
                    state.halls = state.halls.filter(h => h.id !== id);
                    state.selectedHallIds.delete(id);
                    renderHallsGrid();
                }
            };

            // --- Step 2: Student Data ---
            const renderStep2 = () => {
                stepContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-100 rounded-xl p-6 flex flex-col items-center justify-center text-center">
                            <div class="mb-4 bg-white p-3 rounded-full shadow-sm">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">رفع ملف إكسل</h3>
                            <p class="text-gray-500 mb-6 max-w-sm">قم برفع ملف يحتوي على بيانات الطلبة (الاسم، الرقم الامتحاني، المادة، المرحلة)</p>
                            <input type="file" id="excel-upload" accept=".xlsx, .xls" class="hidden">
                            <label for="excel-upload" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 cursor-pointer font-medium transition-colors shadow-lg shadow-blue-600/30">
                                اختيار ملف
                            </label>
                        </div>
                        
                        ${state.students.length > 0 ? `
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                                <h3 class="font-bold text-gray-800">البيانات المستوردة (${state.students.length} طالب)</h3>
                                <button onclick="state.students=[]; updateUI();" class="text-red-500 text-sm hover:underline">حذف البيانات</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-right">
                                    <thead class="bg-gray-50 text-gray-700">
                                        <tr>
                                            <th class="px-4 py-3">الاسم</th>
                                            <th class="px-4 py-3">الرقم الامتحاني</th>
                                            <th class="px-4 py-3">المرحلة/الفرع</th>
                                            <th class="px-4 py-3">المادة</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${state.students.slice(0, 5).map(s => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 font-medium text-gray-900">${s.name}</td>
                                                <td class="px-4 py-3 font-mono text-gray-600">${s.examNo}</td>
                                                <td class="px-4 py-3 text-gray-500">${s.branch}</td>
                                                <td class="px-4 py-3 text-gray-500">${s.subject}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ${state.students.length > 5 ? `<div class="p-3 text-center text-sm text-gray-500 border-t bg-gray-50">...و ${state.students.length - 5} آخرين</div>` : ''}
                            </div>
                        </div>` : ''}
                    </div>
                `;

                const fileInput = document.getElementById('excel-upload');
                if(fileInput) {
                    fileInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if(!file) return;

                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const data = new Uint8Array(evt.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                            
                            // Map generic columns to our schema
                            state.students = jsonData.map((row, index) => ({
                                id: `S${index + 1}`,
                                name: row['الاسم'] || row['name'] || row['اسم الطالب'],
                                examNo: row['الرقم الامتحاني'] || row['exam_no'] || row['رقم الجلوس'],
                                branch: row['الفرع'] || row['الشعبة'] || row['القسم'] || '',
                                subject: row['المادة'] || row['subject'] || ''
                            })).filter(s => s.name); // Basic validation

                            updateUI();
                        };
                        reader.readAsArrayBuffer(file);
                    });
                }
            };

            // --- Step 3: Distribution Logic ---
            const distributeStudents = () => {
                const selectedHalls = state.halls.filter(h => state.selectedHallIds.has(h.id));
                const students = [...state.students]; // Copy
                let currentStudentIndex = 0;
                
                state.distribution = []; // Reset

                selectedHalls.forEach(hall => {
                    for(let r = 0; r < hall.rows; r++) {
                        for(let c = 0; c < hall.cols; c++) {
                            // Snake pattern filling
                            const colIndex = (r % 2 === 0) ? c : (hall.cols - 1 - c);
                            
                            if(currentStudentIndex < students.length) {
                                const student = students[currentStudentIndex];
                                // Seat Label: A1, A2... or R1-C1
                                const seatLabel = `ق${hall.name.match(/\d+/) || hall.name}-م${(r * hall.cols) + colIndex + 1}`; 
                                
                                state.distribution.push({
                                    ...student,
                                    hallId: hall.id,
                                    row: r,
                                    col: colIndex,
                                    seatLabel: seatLabel
                                });
                                currentStudentIndex++;
                            }
                        }
                    }
                });
            };

            const renderStep3 = () => {
                if(state.distribution.length === 0 && state.students.length > 0) {
                    distributeStudents();
                }

                const assignedCount = state.distribution.length;
                const totalCount = state.students.length;
                const unassigned = totalCount - assignedCount;

                stepContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <span class="text-sm text-blue-600 font-bold block mb-1">الطلاب الموزعين</span>
                                <span class="text-2xl font-bold text-gray-900">${assignedCount}</span>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                                <span class="text-sm text-green-600 font-bold block mb-1">نسبة الإشغال</span>
                                <span class="text-2xl font-bold text-gray-900">${Math.round((assignedCount / totalCount) * 100) || 0}%</span>
                            </div>
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                                <span class="text-sm text-red-600 font-bold block mb-1">غير موزعين</span>
                                <span class="text-2xl font-bold text-gray-900">${unassigned}</span>
                            </div>
                        </div>

                        <div class="bg-white border rounded-xl overflow-hidden">
                            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                                <h3 class="font-bold">معاينة التوزيع</h3>
                                <button onclick="distributeStudents(); updateUI();" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                    إعادة توزيع
                                </button>
                            </div>
                            <div class="p-6 overflow-x-auto">
                                <div class="flex gap-8 min-w-max pb-4">
                                    ${state.halls.filter(h => state.selectedHallIds.has(h.id)).map(hall => {
                                        const hallStudents = state.distribution.filter(s => s.hallId === hall.id);
                                        return `
                                            <div class="min-w-[300px] border rounded-lg p-4 bg-gray-50">
                                                <h4 class="font-bold text-center mb-4 pb-2 border-b">${hall.name}</h4>
                                                <div class="grid gap-2" style="grid-template-columns: repeat(${hall.cols}, 1fr)">
                                                    ${Array.from({length: hall.rows * hall.cols}).map((_, idx) => {
                                                        // Calculate row and col for rendering
                                                        const r = Math.floor(idx / hall.cols);
                                                        const c = idx % hall.cols;
                                                        const student = hallStudents.find(s => s.row === r && s.col === c);
                                                        
                                                        return `
                                                            <div class="aspect-square bg-white border rounded flex items-center justify-center text-xs p-1 relative group ${student ? 'border-blue-200 shadow-sm' : 'border-dashed border-gray-300'}">
                                                                ${student ? `
                                                                    <div class="text-center truncate w-full">
                                                                        <div class="font-bold text-gray-900 truncate">${student.name.split(' ')[0]}</div>
                                                                        <div class="text-[10px] text-gray-500 font-mono">${student.seatLabel}</div>
                                                                    </div>
                                                                    <div class="absolute inset-0 bg-gray-900 text-white text-xs opacity-0 group-hover:opacity-100 flex items-center justify-center p-1 text-center rounded bg-opacity-90 transition-opacity z-10 pointer-events-none">
                                                                        ${student.name}
                                                                    </div>
                                                                ` : '<span class="text-gray-300">.</span>'}
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            };

            // --- Step 4: Manual Adjustment (Simplified) ---
            const renderStep4 = () => {
                stepContent.innerHTML = `
                    <div class="h-[600px] flex flex-col items-center justify-center text-gray-500">
                        <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        <p class="text-lg">ميزة السحب والإفلات للتعديل اليدوي</p>
                        <p class="text-sm">(يمكن تفعيلها بالكامل عند الحاجة للتخصيص الدقيق)</p>
                    </div>
                `;
            };

            // --- Step 5: Scanning & Reports ---
            const renderStep5 = () => {
                stepContent.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                        <div class="space-y-6">
                            <div class="bg-white border rounded-xl overflow-hidden shadow-sm">
                                <div class="bg-gray-900 p-4 flex justify-between items-center text-white">
                                    <h3 class="font-bold flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 14.5v.01M12 19v.01M10 7v.01M6.343 11.042A5 5 0 1117.657 11.042M6.343 17.657A9 9 0 0118.818 6.343"/></svg>
                                        ماسح الحضور
                                    </h3>
                                    <span id="scan-status" class="text-xs bg-gray-700 px-2 py-1 rounded-full">جاهز</span>
                                </div>
                                <div class="p-4 bg-gray-100 min-h-[250px] flex flex-col items-center justify-center relative">
                                    <div id="reader" class="w-full"></div>
                                    <div id="scan-placeholder" class="text-center text-gray-500">
                                        <p class="mb-4">انقر لبدء المسح</p>
                                        <button id="start-scan-btn" class="bg-blue-600 text-white px-6 py-2 rounded-full shadow-lg hover:bg-blue-700 transition-transform hover:scale-105">
                                            تشغيل الكاميرا
                                        </button>
                                    </div>
                                    <button id="stop-scan-btn" class="hidden absolute bottom-4 bg-red-600 text-white px-4 py-1 rounded-full text-sm shadow opacity-90 hover:opacity-100">إيقاف</button>
                                </div>
                            </div>

                            <div class="bg-white border rounded-xl p-4 shadow-sm space-y-3">
                                <button onclick="exportSeatsPDF()" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center justify-center gap-2 transition-colors">
                                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                    طباعة خرائط الجلوس (PDF)
                                </button>
                                <button onclick="exportAbsenceToWord()" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 shadow-lg shadow-blue-600/20 transition-all transform hover:-translate-y-0.5">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                    تصدير قائمة الغيابات (Word)
                                </button>
                            </div>
                        </div>

                        <div class="lg:col-span-2 bg-white border rounded-xl overflow-hidden shadow-sm flex flex-col h-[600px]">
                            <div class="p-4 border-b bg-gray-50 flex justify-between items-center sticky top-0">
                                <h3 class="font-bold text-gray-800">سجل الحضور والغياب</h3>
                                <div class="flex gap-2 text-sm">
                                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full">حضور: <span id="present-count">0</span></span>
                                    <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full">غياب: <span id="absent-count">${state.distribution.length}</span></span>
                                </div>
                            </div>
                            <div class="overflow-y-auto flex-1 p-0">
                                <table class="w-full text-right text-sm">
                                    <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10">
                                        <tr>
                                            <th class="px-4 py-3">الحالة</th>
                                            <th class="px-4 py-3">الاسم</th>
                                            <th class="px-4 py-3">القاعة</th>
                                            <th class="px-4 py-3">المقعد</th>
                                            <th class="px-4 py-3">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendance-list" class="divide-y divide-gray-100">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                renderAttendanceList();
                setupScanner();
            };

            const renderAttendanceList = () => {
                const list = document.getElementById('attendance-list');
                const presentCountEl = document.getElementById('present-count');
                const absentCountEl = document.getElementById('absent-count');
                
                if(!list) return;

                // Sort: Present first, then by name
                const sortedStudents = [...state.distribution].sort((a, b) => {
                    const aScanned = state.scannedStudents.has(a.id);
                    const bScanned = state.scannedStudents.has(b.id);
                    if(aScanned && !bScanned) return -1;
                    if(!aScanned && bScanned) return 1;
                    return a.name.localeCompare(b.name);
                });

                list.innerHTML = sortedStudents.map(student => {
                    const isPresent = state.scannedStudents.has(student.id);
                    const hallName = state.halls.find(h => h.id === student.hallId)?.name || 'غير معروف';
                    
                    return `
                        <tr class="hover:bg-gray-50 transition-colors ${isPresent ? 'bg-green-50/50' : ''}">
                            <td class="px-4 py-3">
                                ${isPresent ? 
                                    '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">حاضر</span>' : 
                                    '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">غائب</span>'}
                            </td>
                            <td class="px-4 py-3 font-medium text-gray-900">${student.name}</td>
                            <td class="px-4 py-3 text-gray-500">${hallName}</td>
                            <td class="px-4 py-3 font-mono text-gray-500 text-xs">${student.seatLabel}</td>
                            <td class="px-4 py-3">
                                <button onclick="toggleAttendance('${student.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                                    ${isPresent ? 'إلغاء' : 'تأكيد'}
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                presentCountEl.textContent = state.scannedStudents.size;
                absentCountEl.textContent = state.distribution.length - state.scannedStudents.size;
            };

            window.toggleAttendance = (id) => {
                if(state.scannedStudents.has(id)) {
                    state.scannedStudents.delete(id);
                } else {
                    state.scannedStudents.add(id);
                }
                renderAttendanceList();
            };

            const setupScanner = () => {
                const startBtn = document.getElementById('start-scan-btn');
                const stopBtn = document.getElementById('stop-scan-btn');
                const placeholder = document.getElementById('scan-placeholder');
                const statusEl = document.getElementById('scan-status');

                if(!startBtn) return;

                startBtn.addEventListener('click', () => {
                    html5QrCode = new Html5Qrcode("reader");
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    
                    html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                        // Success
                        // Assume QR contains JSON or just ID/Name. Here checking Name match for demo
                        // In real app, QR should contain unique ID
                        const foundStudent = state.distribution.find(s => s.name === decodedText || s.id === decodedText || decodedText.includes(s.examNo));
                        
                        if(foundStudent) {
                            if(!state.scannedStudents.has(foundStudent.id)) {
                                state.scannedStudents.add(foundStudent.id);
                                renderAttendanceList();
                                // Audio beep could go here
                                statusEl.textContent = `تم تسجيل: ${foundStudent.name}`;
                                statusEl.className = "text-xs bg-green-600 px-2 py-1 rounded-full animate-pulse";
                                setTimeout(() => {
                                    statusEl.textContent = "جاري المسح...";
                                    statusEl.className = "text-xs bg-red-600 px-2 py-1 rounded-full animate-pulse";
                                }, 2000);
                            }
                        }
                    }, (errorMessage) => {
                        // Error (ignore mostly)
                    }).then(() => {
                        placeholder.classList.add('hidden');
                        stopBtn.classList.remove('hidden');
                        statusEl.textContent = "جاري المسح...";
                        statusEl.className = "text-xs bg-red-600 px-2 py-1 rounded-full animate-pulse";
                    });
                });

                stopBtn.addEventListener('click', () => {
                    if(html5QrCode) {
                        html5QrCode.stop().then(() => {
                            html5QrCode.clear();
                            placeholder.classList.remove('hidden');
                            stopBtn.classList.add('hidden');
                            statusEl.textContent = "جاهز";
                            statusEl.className = "text-xs bg-gray-700 px-2 py-1 rounded-full";
                        });
                    }
                });
            };

            // --- Word Export Logic (Modified as per Request) ---
            window.exportAbsenceToWord = () => {
                // 1. تحديد الطلبة الغائبين (الموزعين غير الموجودين في قائمة الحضور)
                const absentees = state.distribution.filter(s => !state.scannedStudents.has(s.id));

                if (absentees.length === 0) {
                    showAlert('لا يوجد طلبة غائبين للتصدير أو لم يتم بدء تسجيل الحضور.');
                    if(!confirm('القائمة فارغة، هل تريد تصدير النموذج فارغاً؟')) return;
                }

                // 2. تجهيز صفوف الجدول
                const tableRows = absentees.map((s, index) => {
                    const hallName = state.halls.find(h => h.id === s.hallId)?.name || '';
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${s.name}</td>
                            <td>${s.branch || '-'}</td>
                            <td>${s.examNo}</td>
                            <td>${hallName}</td>
                            <td>${s.seatLabel}</td>
                        </tr>
                    `;
                }).join('');

                // 3. كود HTML الكامل لتوليد ملف Word مطابق للصورة
                // يستخدم XML Namespaces ليفهم Word التنسيق بشكل صحيح
                const htmlContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset='utf-8'>
                        <title>قائمة الغيابات</title>
                        <style>
                            @page {
                                size: A4;
                                margin: 2cm;
                                mso-page-orientation: portrait;
                            }
                            body {
                                font-family: 'Times New Roman', serif; /* خط رسمي */
                            }
                            .header-container {
                                text-align: center;
                                margin-bottom: 20px;
                            }
                            .header-text {
                                font-size: 14pt;
                                font-weight: bold;
                                margin: 5px 0;
                            }
                            .title {
                                font-size: 18pt;
                                font-weight: bold;
                                text-decoration: underline;
                                margin: 20px 0;
                                text-align: center;
                            }
                            .meta-info {
                                text-align: right;
                                font-size: 14pt;
                                margin-bottom: 10px;
                                dir: rtl;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                dir: rtl;
                                margin-top: 10px;
                            }
                            th, td {
                                border: 1px solid black;
                                padding: 8px;
                                text-align: center;
                                font-size: 12pt;
                            }
                            th {
                                background-color: #D9D9D9; /* لون رصاصي للخلفية كما في الصورة */
                                font-weight: bold;
                            }
                        </style>
                    </head>
                    <body dir="rtl">
                        <div class="header-container">
                            <div class="header-text">جمهورية العراق</div>
                            <div class="header-text">وزارة التعليم العالي والبحث العلمي</div>
                            <div class="header-text">اللجنة الامتحانية</div>
                        </div>

                        <div class="title">قائمة الطلبة الغائبين</div>

                        <div class="meta-info">
                            <p><strong>التاريخ:</strong> ${new Date().toLocaleDateString('ar-IQ')}</p>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th width="5%">ت</th>
                                    <th width="30%">اسم الطالب</th>
                                    <th width="15%">الشعبة / القسم</th>
                                    <th width="20%">الرقم الامتحاني</th>
                                    <th width="15%">رقم القاعة الامتحانية</th>
                                    <th width="15%">رقم القطاع / المقعد</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 50px; display: flex; justify-content: space-between; direction: rtl;">
                            <div style="float: right; width: 40%; text-align: center;">
                                <p><strong>عضو اللجنة الامتحانية</strong></p>
                            </div>
                            <div style="float: left; width: 40%; text-align: center;">
                                <p><strong>رئيس اللجنة الامتحانية</strong></p>
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                // 4. إنشاء ملف Blob وتحميله
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `قائمة_الغيابات_${new Date().toLocaleDateString('ar-IQ').replace(/\//g, '-')}.doc`; // .doc لضمان التوافق الأكبر
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            window.exportSeatsPDF = () => {
                // Simplified PDF export placeholder
                window.print();
            };

            // --- Navigation Logic ---
            const navigate = (direction) => {
                if (direction === 'next' && state.currentStep === 1 && state.selectedHallIds.size === 0) {
                    showAlert('الرجاء تحديد قاعة واحدة على الأقل للمتابعة.');
                    return;
                }
                const newStep = state.currentStep + (direction === 'next' ? 1 : -1);
                if (newStep > 0 && newStep <= steps.length) {
                    if(state.currentStep === 5 && html5QrCode && html5QrCode.isScanning) {
                        document.getElementById('stop-scan-btn').click();
                    }
                    state.currentStep = newStep;
                    updateUI();
                }
            };
            const showAlert = (message) => {
                const alertBox = document.getElementById('custom-alert');
                const alertMessage = document.getElementById('alert-message');
                alertMessage.textContent = message;
                alertBox.classList.remove('hidden');
                setTimeout(() => alertBox.classList.add('hidden'), 3000);
            };

            nextBtn.addEventListener('click', () => navigate('next'));
            prevBtn.addEventListener('click', () => navigate('prev'));

            updateUI();
        });
    </script>
</body>
</html>
