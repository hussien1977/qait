<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¬Ù„ÙˆØ³ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body { font-family: 'Cairo', sans-serif; }
        .step-section { display: none; }
        .step-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .seat { transition: all 0.2s ease-in-out; }
        .seat.disabled { background-color: #4b5563 !important; border-color: #1f2937 !important; cursor: not-allowed; }
        .seat.disabled::after { content: 'âœ•'; color: white; font-size: 1.5rem; display: flex; justify-content: center; align-items: center; height: 100%; }
        .seat.occupied { background-color: #e0f2fe; border-color: #0284c7; }
        .seat.conflict { border: 3px solid #ef4444 !important; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        .student-card { cursor: grab; }
        .student-card:active { cursor: grabbing; }
        .droppable-hover { background-color: #d1fae5 !important; }
        
        #hall-modal-backdrop, #preview-modal-backdrop { background-color: rgba(0,0,0,0.5); }
        
        .pdf-page-container {
            background: white; width: 210mm; min-height: 297mm; padding: 1cm;
            position: absolute; left: -9999px; top: 0;
            font-family: 'Cairo', sans-serif; display: flex; flex-direction: column;
        }
        .pdf-header {
            background-size: cover; background-position: center; background-repeat: no-repeat;
            padding: 20px; border: 2px solid black; border-radius: 10px;
            text-align: center; position: relative; overflow: hidden;
        }
        .pdf-body {
            flex-grow: 1; background-size: cover; background-position: center; background-repeat: no-repeat;
            padding-top: 20px; position: relative; overflow: hidden;
        }
        .pdf-bg-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;
        }
        .pdf-content { position: relative; z-index: 1; }
        
        #reader { width: 100%; max-width: 500px; margin: 20px auto; border: 2px solid #d1d5db; border-radius: 8px; overflow: hidden; }
        #scan-feedback .success { color: #16a34a; }
        #scan-feedback .fail { color: #dc2626; }

        /* Custom Button Styles */
        .action-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem;
            transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        .action-btn:active { transform: translateY(0); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-icon { width: 18px; height: 18px; fill: currentColor; }
        
        /* QR Code Styles - Fixed Size */
        .qr-code-container {
            width: 60px !important;
            height: 60px !important;
            min-width: 60px !important;
            min-height: 60px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            margin: 2px auto !important;
            overflow: hidden !important;
        }
        
        .qr-code-container canvas,
        .qr-code-container img {
            width: 60px !important;
            height: 60px !important;
            max-width: 60px !important;
            max-height: 60px !important;
            object-fit: contain !important;
        }
        
        .pdf-qr-code {
            width: 80px !important;
            height: 80px !important;
            min-width: 80px !important;
            min-height: 80px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            margin: 5px auto !important;
        }
        
        .pdf-qr-code canvas,
        .pdf-qr-code img {
            width: 80px !important;
            height: 80px !important;
            max-width: 80px !important;
            max-height: 80px !important;
            object-fit: contain !important;
        }
    </style>
</head>
<body class="bg-stone-50 text-slate-800">

    <div id="login-screen" class="fixed inset-0 bg-stone-100 z-50 flex flex-col items-center justify-center">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg border border-slate-200 w-11/12 max-w-md">
            <h1 class="text-3xl font-bold text-sky-700 mb-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¬Ù„ÙˆØ³</h1>
            <p class="text-slate-500 mb-6">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            
            <div class="space-y-4">
                <button id="login-anonymous-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-3 shadow-sm">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    <span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©</span>
                </button>
                
                <div class="relative my-4">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">Ø£Ùˆ</span>
                    </div>
                </div>
                
                <button id="login-google-btn" class="w-full bg-white text-slate-700 border border-slate-300 font-bold py-3 px-8 rounded-lg hover:bg-slate-50 transition flex items-center justify-center gap-3 shadow-sm">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
                        <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                        <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
                        <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19-5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                    </svg>
                    <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</span>
                </button>
            </div>
            
            <p class="text-xs text-slate-400 mt-6">
                Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø§ ÙŠØªØ·Ù„Ø¨ Ø­Ø³Ø§Ø¨ Ø¬ÙŠÙ…ÙŠÙ„ØŒ Ø¨ÙŠÙ†Ù…Ø§ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Google Drive.
            </p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            
            <header class="text-center mb-8 border-b pb-4 relative">
                <div id="auth-info" class="w-full flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div id="welcome-message" class="text-sm font-bold text-sky-800 bg-sky-50 px-4 py-2 rounded-lg border border-sky-100"></div>
                    
                    <div class="flex flex-wrap items-center justify-center gap-3">
                        <button id="sync-to-drive-btn" class="action-btn bg-emerald-600 text-white hover:bg-emerald-700 hidden">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                            Ø­ÙØ¸ ÙÙŠ Drive
                        </button>
                        
                        <button id="load-from-drive-btn" class="action-btn bg-indigo-600 text-white hover:bg-indigo-700 hidden">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>
                            ØªØ­Ù…ÙŠÙ„ Ù…Ù† Drive
                        </button>
                        
                        <button id="clear-data-btn" class="action-btn bg-rose-600 text-white hover:bg-rose-700">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>

                        <button id="logout-btn" class="action-btn bg-slate-600 text-white hover:bg-slate-700">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                            Ø®Ø±ÙˆØ¬
                        </button>
                    </div>
                </div>
                
                <span id="drive-sync-status" class="block text-xs font-semibold text-emerald-600 h-4 mb-2"></span>

                <h1 class="text-3xl md:text-4xl font-bold text-sky-700">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¬Ù„ÙˆØ³ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØ©</h1>
                <p class="text-slate-500 mt-2">Ø£Ø¯Ø§Ø© Ø°ÙƒÙŠØ© Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØ© Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆÙƒÙØ§Ø¡Ø©</p>
                <div class="mt-4 flex flex-col items-center">
                    <p class="text-xl font-bold text-red-600">Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ§Ø° : Ø­Ø³ÙŠÙ† Ø¬Ù‡Ø§Ø¯ Ø±Ø¶Ø§</p>
                    <p class="text-xl font-bold text-purple-600">Ø§Ø´Ø±Ø§Ù Ø§Ù„Ø§Ø³ØªØ§Ø° : ØªØ­Ø³ÙŠÙ† Ù‡Ø§Ø±ÙˆÙ† Ù…Ù‡Ø¯ÙŠ</p>
                </div>
            </header>

            <div id="stepper" class="flex justify-center items-center mb-10 space-x-4 md:space-x-8 rtl:space-x-reverse"></div>

            <main class="bg-white rounded-xl shadow-lg p-6 md:p-8 min-h-[500px]">
                
                <section id="step-1" class="step-section active">
                     <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØ©</h2>
                        <p class="text-slate-500 mt-1">Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø­Ø¯Ø¯ Ù‚Ø§Ø¹Ø© Ø£Ùˆ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡Ø§.</p>
                     </div>
                    <div class="mb-6 text-center">
                        <button id="show-hall-modal-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-md hover:bg-sky-700 transition shadow-md">
                              + Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                         </button>
                    </div>
                    <div id="halls-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>

                <section id="step-2" class="step-section">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                        <p class="text-slate-500 mt-1">Ù‚Ù… Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ù…Ù„Ù Excel Ø£Ùˆ Ù‚Ù… Ø¨Ù„ØµÙ‚Ù‡Ø§ ÙƒÙ†Øµ.</p>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div class="flex border-b mb-4">
                                <button data-tab="paste-tab" class="tab-btn flex-1 py-2 font-semibold border-b-4 border-sky-600 text-sky-600">Ù„ØµÙ‚ Ù†Øµ</button>
                                <button data-tab="upload-tab" class="tab-btn flex-1 py-2 font-semibold text-gray-500">Ø±ÙØ¹ Ù…Ù„Ù Excel</button>
                            </div>

                            <div id="paste-tab" class="tab-content">
                                <h3 class="font-bold mb-2">Ù„ØµÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨:</h3>
                                <p class="text-sm text-slate-500 mb-2">Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙƒÙ„ Ø·Ø§Ù„Ø¨ ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚: <br><code class="bg-gray-200 p-1 rounded">Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØŒ Ø§Ù„ØµÙØŒ Ø§Ù„Ø´Ø¹Ø¨Ø©</code></p>
                                <textarea id="students-text" rows="8" class="w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„:&#10;Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠØŒ 1201ØŒ Ø§Ù„Ø¹Ø§Ø´Ø±ØŒ Ø£&#10;ÙØ§Ø·Ù…Ø© Ù…Ø­Ù…Ø¯ØŒ 1202ØŒ Ø§Ù„Ø¹Ø§Ø´Ø±ØŒ Ø¨"></textarea>
                                <button id="import-text-btn" class="mt-2 w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-md hover:bg-sky-700 transition">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø§Ù„Ù†Øµ</button>
                            </div>

                            <div id="upload-tab" class="tab-content hidden">
                                 <h3 class="font-bold mb-2">Ø±ÙØ¹ Ù…Ù„Ù Excel (.xlsx):</h3>
                                 <p class="text-sm text-slate-500 mb-2">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨: <br><code class="bg-gray-200 p-1 rounded">Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠØŒ Ø§Ù„ØµÙØŒ Ø§Ù„Ø´Ø¹Ø¨Ø©</code></p>
                                 <input type="file" id="excel-file" accept=".xlsx, .xls" class="w-full p-2 border rounded-md file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h3 class="font-bold text-lg mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (<span id="student-count">0</span>)</h3>
                            <div id="student-list" class="h-64 overflow-y-auto space-y-2 pr-2">
                                <p class="text-slate-400 text-center mt-8">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="step-3" class="step-section">
                    <div id="distribution-header" class="text-center mb-8">
                         <h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„ØªÙˆØ²ÙŠØ¹ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
                         <p class="text-slate-500 mt-1">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„ÙØ§Ø±ØºØ© Ù„ØªØ¹Ø·ÙŠÙ„Ù‡Ø§. Ø«Ù… Ù‚Ù… Ø¨Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ùˆ Ø§Ù„ÙŠØ¯ÙˆÙŠ.</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div class="lg:col-span-1 bg-gray-50 p-4 rounded-lg border">
                            <h3 class="font-bold text-lg mb-4">Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ²Ø¹ÙŠÙ†</h3>
                            <div id="unassigned-students" class="h-96 overflow-y-auto space-y-2 p-1"></div>
                            <button id="auto-distribute-btn" class="mt-4 w-full bg-emerald-600 text-white font-bold py-2 px-4 rounded-md hover:bg-emerald-700 transition">ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                            <button id="reset-distribution-btn" class="mt-2 w-full bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
                        </div>

                        <div id="multi-hall-distribution-container" class="lg:col-span-3 space-y-8"></div>
                     </div>
                </section>

                <section id="step-4" class="step-section">
                    <div id="export-header" class="text-center mb-8">
                        <h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©</h2>
                        <p class="text-slate-500 mt-1">Ø§Ø®ØªØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± Ø«Ù… Ù‚Ù… Ø¨Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£Ùˆ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª.</p>
                    </div>
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-gray-50 p-6 rounded-lg border mb-6 space-y-4">
                            <label class="flex items-center justify-center cursor-pointer">
                                <span class="font-semibold ml-4">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ù„ÙÙŠØ§Øª Ù…Ø®ØµØµØ©:</span>
                                <div class="relative">
                                    <input type="checkbox" id="use-backgrounds-toggle" class="sr-only peer">
                                    <div class="block bg-gray-300 w-14 h-8 rounded-full peer-checked:bg-sky-600"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform transform peer-checked:translate-x-full"></div>
                                </div>
                            </label>
                            <div id="background-inputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t">
                                <div class="flex-1">
                                    <label for="header-bg-input" class="block font-semibold mb-1">Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                                    <input type="file" id="header-bg-input" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/>
                                </div>
                                <div class="flex-1">
                                    <label for="body-bg-input" class="block font-semibold mb-1">Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„:</label>
                                    <input type="file" id="body-bg-input" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/>
                                </div>
                                <div class="md:col-span-2 space-y-2">
                                    <div>
                                        <label for="header-opacity-slider" class="block font-semibold mb-1">Ø´ÙØ§ÙÙŠØ© Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span id="header-opacity-value">100</span>%</label>
                                        <input type="range" id="header-opacity-slider" min="0" max="1" step="0.05" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    </div>
                                    <div>
                                        <label for="body-opacity-slider" class="block font-semibold mb-1">Ø´ÙØ§ÙÙŠØ© Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„: <span id="body-opacity-value">100</span>%</label>
                                        <input type="range" id="body-opacity-slider" min="0" max="1" step="0.05" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row justify-center gap-4">
                            <button id="preview-pdf-btn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-md hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                                <span>ğŸ‘ï¸</span> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø®Ø·Ø·
                            </button>
                            <button id="export-chart-pdf-btn" class="bg-sky-600 text-white font-bold py-3 px-6 rounded-md hover:bg-sky-700 transition flex items-center justify-center gap-2">
                                <span>ğŸ“„</span> ØªØµØ¯ÙŠØ± Ù…Ø®Ø·Ø· Ø§Ù„Ù‚Ø§Ø¹Ø§Øª (PDF)
                            </button>
                            <button id="export-list-pdf-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-md hover:bg-green-700 transition flex items-center justify-center gap-2">
                                <span>ğŸ“‹</span> ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (PDF)
                            </button>
                        </div>
                    </div>
                </section>

                <section id="step-5" class="step-section">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 5: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</h2>
                        <p class="text-slate-500 mt-1">Ø§Ù…Ø³Ø­ Ø±Ù…ÙˆØ² QR Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ØŒ Ø«Ù… Ù‚Ù… Ø¨ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-bold text-lg mb-4 text-center">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø§Ø³Ø­</h3>
                            <div class="flex justify-center gap-4 mb-4">
                                <button id="start-scan-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-md hover:bg-green-700 transition">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­</button>
                                <button id="stop-scan-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-md hover:bg-red-700 transition hidden">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­</button>
                            </div>
                            <div id="reader"></div>
                            <div id="scan-feedback" class="text-center font-semibold mt-2 h-6"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h3 class="font-bold text-lg mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ† (<span id="absent-count">0</span>)</h3>
                            <div id="absent-list" class="h-64 overflow-y-auto space-y-2 pr-2">
                                <p class="text-slate-400 text-center mt-8">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ ØºÙŠØ§Ø¨ Ø¨Ø¹Ø¯.</p>
                            </div>
                            
                            <h4 class="font-bold mt-4 mb-2 text-gray-700 border-t pt-2">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                <button id="export-absent-pdf-img-btn" class="bg-orange-500 text-white font-bold py-2 px-2 rounded-md hover:bg-orange-600 transition text-sm flex justify-center items-center gap-1" disabled>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    ØµÙˆØ±Ø©
                                </button>
                                <button id="export-absent-file-pdf-btn" class="bg-red-600 text-white font-bold py-2 px-2 rounded-md hover:bg-red-700 transition text-sm flex justify-center items-center gap-1" disabled>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                    Ù…Ù„Ù PDF
                                </button>
                                <button id="export-absent-word-btn" class="bg-blue-600 text-white font-bold py-2 px-2 rounded-md hover:bg-blue-700 transition text-sm flex justify-center items-center gap-1" disabled>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Ù…Ù„Ù Word
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <div id="navigation-btns" class="mt-10 flex justify-between border-t pt-6">
                    <button id="prev-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-md hover:bg-gray-300 transition" disabled>Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button id="next-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-md hover:bg-sky-700 transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
            </main>
        </div>
    </div>

    <div id="hall-modal-backdrop" class="fixed inset-0 z-40 hidden">
        <div id="hall-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 id="hall-modal-title" class="text-2xl font-bold mb-6">Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <form id="hall-form" class="space-y-4">
                <input type="hidden" id="hall-id-input">
                <div>
                    <label for="hall-name" class="block font-semibold mb-1">Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¹Ø©:</label>
                    <input type="text" id="hall-name" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø§Ø¹Ø© 101" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div>
                    <label for="hall-location" class="block font-semibold mb-1">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø§Ø¹Ø©:</label>
                    <input type="text" id="hall-location" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-sky-500">
                </div>
                <div>
                    <label for="hall-rows" class="block font-semibold mb-1">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ:</label>
                    <input type="number" id="hall-rows" min="1" max="30" value="5" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="hall-sector1-cols" class="block font-semibold mb-1">Ø£Ø¹Ù…Ø¯Ø© Ù‚Ø·Ø§Ø¹ 1:</label>
                        <input type="number" id="hall-sector1-cols" min="1" max="15" value="3" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-sky-500" required>
                    </div>
                    <div>
                        <label for="hall-sector2-cols" class="block font-semibold mb-1">Ø£Ø¹Ù…Ø¯Ø© Ù‚Ø·Ø§Ø¹ 2:</label>
                        <input type="number" id="hall-sector2-cols" min="1" max="15" value="3" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-sky-500" required>
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" id="cancel-hall-modal-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-md hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-md hover:bg-sky-700 transition">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¹Ø©</button>
                </div>
            </form>
        </div>
    </div>

    <div id="preview-modal-backdrop" class="fixed inset-0 z-40 hidden items-center justify-center">
        <div id="preview-modal" class="bg-white p-4 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-xl font-bold">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù</h2>
                <button id="close-preview-modal-btn" class="text-2xl font-bold">&times;</button>
            </div>
            <div id="preview-content" class="flex justify-center"></div>
        </div>
     </div>
    
    <div id="custom-alert" class="hidden fixed top-5 right-5 bg-red-500 text-white py-3 px-5 rounded-lg shadow-xl z-50 animate-bounce">
        <p id="alert-message"></p>
    </div>

    <div id="progress-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-11/12 md:w-1/3">
            <h3 id="progress-title" class="text-lg font-bold mb-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù„Ù...</h3>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%;"></div>
            </div>
            <p id="progress-text" class="mt-2 text-sm text-gray-600">0%</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Firebase and Google API Config ---
            const firebaseConfig = {
                apiKey: "AIzaSyDqGTfHTuj1cu2a6eTPYR29l7H65Q-x810",
                authDomain: "murasil-al-moalem.firebaseapp.com",
                projectId: "murasil-al-moalem",
                storageBucket: "murasil-al-moalem.appspot.com",
                messagingSenderId: "314929620446",
                appId: "1:314929620446:web:fb7abd1cee260d85dca94f"
            };
            const GOOGLE_API_KEY = 'AIzaSyDqGTfHTuj1cu2a6eTPYR29l7H65Q-x810';
            const GOOGLE_CLIENT_ID = '314929620446-8pjqlrmgkgl9bhppkejvucfpqnamjmqu.apps.googleusercontent.com';
            const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.file';
            const DRIVE_DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
            const APP_DATA_FILENAME = 'seating-chart-app-data.json';

            // --- Firebase Authentication ---
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');
            const loginAnonymousBtn = document.getElementById('login-anonymous-btn');
            const loginGoogleBtn = document.getElementById('login-google-btn');
            const logoutBtn = document.getElementById('logout-btn');

            let firebaseInitialized = false;
            
            try {
                firebase.initializeApp(firebaseConfig);
                firebaseInitialized = true;
            } catch (e) {
                console.log("Firebase already initialized or failed to initialize");
            }
            
            let appInitialized = false;
            let gapiInited = false;
            let tokenClient;
            let currentUser = null;
            let isAnonymousUser = false;

            // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
            loginAnonymousBtn.addEventListener('click', () => {
                isAnonymousUser = true;
                currentUser = {
                    uid: 'anonymous_' + Date.now(),
                    displayName: 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±'
                };
                
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                const welcomeMsg = document.getElementById('welcome-message');
                welcomeMsg.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.displayName} (Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±)`;
                
                document.getElementById('sync-to-drive-btn').classList.add('hidden');
                document.getElementById('load-from-drive-btn').classList.add('hidden');
                
                initializeAppLogic(currentUser);
            });

            // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„
            if (firebaseInitialized) {
                const auth = firebase.auth();
                const provider = new firebase.auth.GoogleAuthProvider();

                loginGoogleBtn.addEventListener('click', () => {
                    auth.signInWithPopup(provider).catch((error) => {
                        console.error("Authentication failed:", error);
                        showAlert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                    });
                });

                logoutBtn.addEventListener('click', () => {
                    auth.signOut();
                    isAnonymousUser = false;
                    currentUser = null;
                });

                auth.onAuthStateChanged(user => {
                    if (user && !isAnonymousUser) {
                        currentUser = user;
                        if (!appInitialized) {
                            appInitialized = true;
                            loginScreen.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            
                            const welcomeMsg = document.getElementById('welcome-message');
                            welcomeMsg.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.displayName}`;
                            
                            document.getElementById('sync-to-drive-btn').classList.remove('hidden');
                            document.getElementById('load-from-drive-btn').classList.remove('hidden');
                            
                            initializeAppLogic(user);
                            gapi.load('client', initializeGapiClient);
                        }
                    } else if (!isAnonymousUser) {
                        appInitialized = false;
                        gapiInited = false;
                        isAnonymousUser = false;
                        loginScreen.classList.remove('hidden');
                        appContainer.classList.add('hidden');
                    }
                });
            }

            async function initializeGapiClient() {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        discoveryDocs: DRIVE_DISCOVERY_DOCS,
                    });
                    gapiInited = true;
                } catch(e) {
                    console.error("Error initializing GAPI client:", e);
                    showAlert("ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Google Drive. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© API Key.");
                }

                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: DRIVE_SCOPE,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            gapi.client.setToken(tokenResponse);
                        } else {
                            console.error("Provided token response was invalid", tokenResponse);
                            showAlert("ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† Google.");
                        }
                    },
                });
            }


            function initializeAppLogic(user) {
                // --- State Management ---
                let state = {
                    currentStep: 1,
                    halls: [],
                    selectedHallIds: new Set(),
                    students: [],
                    seatingChart: new Map(),
                    columnClassAssignments: new Map(),
                    backgrounds: { header: null, body: null, use: false, headerOpacity: 1, bodyOpacity: 1 },
                    absentStudents: [],
                };
                let html5QrCode;
                let fileId = null; 

                // --- DOM Elements ---
                const stepperContainer = document.getElementById('stepper');
                const sections = document.querySelectorAll('.step-section');
                const nextBtn = document.getElementById('next-btn');
                const prevBtn = document.getElementById('prev-btn');
                const hallsListContainer = document.getElementById('halls-list-container');
                const showHallModalBtn = document.getElementById('show-hall-modal-btn');
                const hallModalBackdrop = document.getElementById('hall-modal-backdrop');
                const hallModal = document.getElementById('hall-modal');
                const hallModalTitle = document.getElementById('hall-modal-title');
                const cancelHallModalBtn = document.getElementById('cancel-hall-modal-btn');
                const hallForm = document.getElementById('hall-form');
                const hallIdInput = document.getElementById('hall-id-input');
                const hallNameInput = document.getElementById('hall-name');
                const hallLocationInput = document.getElementById('hall-location');
                const hallRowsInput = document.getElementById('hall-rows');
                const hallSector1ColsInput = document.getElementById('hall-sector1-cols');
                const hallSector2ColsInput = document.getElementById('hall-sector2-cols');
                const studentsTextInput = document.getElementById('students-text');
                const importTextBtn = document.getElementById('import-text-btn');
                const studentListContainer = document.getElementById('student-list');
                const studentCountSpan = document.getElementById('student-count');
                const excelFileInput = document.getElementById('excel-file');
                const tabBtns = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                const multiHallDistributionContainer = document.getElementById('multi-hall-distribution-container');
                const autoDistributeBtn = document.getElementById('auto-distribute-btn');
                const resetDistributionBtn = document.getElementById('reset-distribution-btn');
                const unassignedStudentsContainer = document.getElementById('unassigned-students');
                const exportHeader = document.getElementById('export-header');
                const exportChartPdfBtn = document.getElementById('export-chart-pdf-btn');
                const exportListPdfBtn = document.getElementById('export-list-pdf-btn');
                const useBackgroundsToggle = document.getElementById('use-backgrounds-toggle');
                const backgroundInputs = document.getElementById('background-inputs');
                const headerBgInput = document.getElementById('header-bg-input');
                const bodyBgInput = document.getElementById('body-bg-input');
                const headerOpacitySlider = document.getElementById('header-opacity-slider');
                const bodyOpacitySlider = document.getElementById('body-opacity-slider');
                const headerOpacityValue = document.getElementById('header-opacity-value');
                const bodyOpacityValue = document.getElementById('body-opacity-value');
                const previewPdfBtn = document.getElementById('preview-pdf-btn');
                const previewModalBackdrop = document.getElementById('preview-modal-backdrop');
                const previewContent = document.getElementById('preview-content');
                const closePreviewModalBtn = document.getElementById('close-preview-modal-btn');
                const clearDataBtn = document.getElementById('clear-data-btn');
                const syncToDriveBtn = document.getElementById('sync-to-drive-btn');
                const loadFromDriveBtn = document.getElementById('load-from-drive-btn');
                const driveSyncStatus = document.getElementById('drive-sync-status');
                const startScanBtn = document.getElementById('start-scan-btn');
                const stopScanBtn = document.getElementById('stop-scan-btn');
                const readerDiv = document.getElementById('reader');
                const scanFeedbackDiv = document.getElementById('scan-feedback');
                const absentListContainer = document.getElementById('absent-list');
                const absentCountSpan = document.getElementById('absent-count');
                
                // New Buttons
                const exportAbsentImgBtn = document.getElementById('export-absent-pdf-img-btn');
                const exportAbsentPdfBtn = document.getElementById('export-absent-file-pdf-btn');
                const exportAbsentWordBtn = document.getElementById('export-absent-word-btn');
                
                const progressModal = document.getElementById('progress-modal');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const progressTitle = document.getElementById('progress-title');

                const steps = [
                    { id: 1, name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª' }, { id: 2, name: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨' }, { id: 3, name: 'Ø§Ù„ØªÙˆØ²ÙŠØ¹' },
                    { id: 4, name: 'Ø§Ù„ØªØµØ¯ÙŠØ±' }, { id: 5, name: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨' }
                ];

                // --- Persistence Logic ---
                const saveStateToLocalStorage = () => {
                    try {
                        const stateToSave = {
                            ...state,
                            selectedHallIds: [...state.selectedHallIds],
                            seatingChart: [...state.seatingChart],
                            columnClassAssignments: [...state.columnClassAssignments],
                            halls: state.halls.map(h => ({ ...h, disabledSeats: [...h.disabledSeats] })),
                            backgrounds: { ...state.backgrounds, header: null, body: null }
                        };
                        localStorage.setItem(`seatingChartState_${user.uid}`, JSON.stringify(stateToSave));
                    } catch (e) {
                        console.error("Failed to save state:", e);
                        showAlert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø³Ø¹Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©.");
                    }
                };

                const loadStateFromLocalStorage = () => {
                    const savedStateJSON = localStorage.getItem(`seatingChartState_${user.uid}`);
                    if (savedStateJSON) {
                        try {
                            const savedState = JSON.parse(savedStateJSON);
                            state = {
                                ...state,
                                ...savedState,
                                selectedHallIds: new Set(savedState.selectedHallIds || []),
                                seatingChart: new Map(savedState.seatingChart || []),
                                columnClassAssignments: new Map(savedState.columnClassAssignments || []),
                                halls: savedState.halls.map(h => ({ ...h, disabledSeats: new Set(h.disabledSeats || []) })),
                            };
                        } catch (e) {
                            console.error("Failed to load state:", e);
                            localStorage.removeItem(`seatingChartState_${user.uid}`);
                        }
                    }
                };

                clearDataBtn.addEventListener('click', () => {
                    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ Ù„Ù† ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Drive.")) {
                        localStorage.removeItem(`seatingChartState_${user.uid}`);
                        window.location.reload();
                    }
                });

                // --- Google Drive Logic ---
                function handleDriveAction(actionCallback) {
                    if (!gapiInited || !tokenClient) {
                        showAlert('ÙˆØ§Ø¬Ù‡Ø© Google API Ù„Ù… ØªÙÙ‡ÙŠØ£ Ø¨Ø¹Ø¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.');
                        return;
                    }

                    tokenClient.callback = async (resp) => {
                        if (resp.error !== undefined) {
                            showAlert('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Google Drive.');
                            throw (resp);
                        }
                        await actionCallback();
                    };

                    if (gapi.client.getToken() === null) {
                        tokenClient.requestAccessToken({prompt: 'consent'});
                    } else {
                        tokenClient.requestAccessToken({prompt: ''});
                    }
                }

                async function findAppFile() {
                    try {
                        const response = await gapi.client.drive.files.list({
                            q: `name='${APP_DATA_FILENAME}' and 'root' in parents and trashed=false`,
                            spaces: 'drive',
                            fields: 'files(id, name)'
                        });
                        if (response.result.files && response.result.files.length > 0) {
                            return response.result.files[0].id;
                        }
                        return null;
                    } catch (err) {
                        console.error("Error finding file:", err);
                        return null;
                    }
                }

                async function saveToDrive() {
                    driveSyncStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                    const stateToSave = {
                        ...state,
                        selectedHallIds: [...state.selectedHallIds],
                        seatingChart: [...state.seatingChart],
                        columnClassAssignments: [...state.columnClassAssignments],
                        halls: state.halls.map(h => ({ ...h, disabledSeats: [...h.disabledSeats] })),
                    };
                    const content = JSON.stringify(stateToSave);
                    
                    if (!fileId) {
                        fileId = await findAppFile();
                    }

                    const metadata = {
                        'name': APP_DATA_FILENAME,
                        'mimeType': 'application/json',
                    };

                    let path;
                    let method;
                    let requestBody;
                    let headers = {};

                    if (fileId) {
                        path = `/upload/drive/v3/files/${fileId}?uploadType=media`;
                        method = 'PATCH';
                        requestBody = content;
                        headers = {'Content-Type': 'application/json'};
                    } else {
                        path = `/upload/drive/v3/files?uploadType=multipart`;
                        method = 'POST';
                        metadata.parents = ['root'];

                        const boundary = '-------314159265358979323846';
                        const delimiter = "\r\n--" + boundary + "\r\n";
                        const close_delim = "\r\n--" + boundary + "--";

                        const multipartRequestBody =
                            delimiter +
                            'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                            JSON.stringify(metadata) +
                            delimiter +
                            'Content-Type: application/json\r\n\r\n' +
                            content +
                            close_delim;
                        requestBody = multipartRequestBody;
                        headers = {'Content-Type': 'multipart/related; boundary="' + boundary + '"'};
                    }

                    try {
                        const response = await gapi.client.request({
                            path: path,
                            method: method,
                            headers: headers,
                            body: requestBody
                        });
                        fileId = response.result.id;
                        driveSyncStatus.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!';
                    } catch (err) {
                        console.error("Error saving to drive:", err);
                        driveSyncStatus.textContent = 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸!';
                    }
                    setTimeout(() => driveSyncStatus.textContent = '', 3000);
                }
                
                async function loadFromDrive() {
                    driveSyncStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
                    if (!fileId) {
                        fileId = await findAppFile();
                    }

                    if (fileId) {
                        try {
                            const response = await gapi.client.drive.files.get({
                                fileId: fileId,
                                alt: 'media'
                            });
                            const savedState = JSON.parse(response.body);
                            state = {
                                ...state,
                                ...savedState,
                                selectedHallIds: new Set(savedState.selectedHallIds || []),
                                seatingChart: new Map(savedState.seatingChart || []),
                                columnClassAssignments: new Map(savedState.columnClassAssignments || []),
                                halls: savedState.halls.map(h => ({ ...h, disabledSeats: new Set(h.disabledSeats || []) })),
                            };
                            saveStateToLocalStorage();
                            updateUI(); 
                            driveSyncStatus.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!';

                            if (state.seatingChart.size > 0) {
                                state.currentStep = 5;
                                updateUI();
                                showAlert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­. ØªÙ… Ù†Ù‚Ù„Ùƒ Ø¥Ù„Ù‰ Ø®Ø·ÙˆØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨.');
                            }

                        } catch (err) {
                            console.error("Error loading from drive:", err);
                            driveSyncStatus.textContent = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„!';
                        }
                    } else {
                        driveSyncStatus.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.';
                    }
                    setTimeout(() => driveSyncStatus.textContent = '', 3000);
                }

                syncToDriveBtn.addEventListener('click', () => handleDriveAction(saveToDrive));
                loadFromDriveBtn.addEventListener('click', () => handleDriveAction(loadFromDrive));

                function updateProgress(current, total, title = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù„Ù...") {
                    if (current === 0 && total > 0) {
                        progressTitle.textContent = title;
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';
                        progressModal.classList.remove('hidden');
                        return;
                    }

                    const percentage = Math.round((current / total) * 100);
                    progressBar.style.width = percentage + '%';
                    progressText.textContent = percentage + '%';
                    if (current >= total) {
                        setTimeout(() => {
                            progressModal.classList.add('hidden');
                        }, 500);
                    }
                }

                const updateUI = () => {
                    renderStepper();
                    sections.forEach(s => s.classList.remove('active'));
                    document.getElementById(`step-${state.currentStep}`).classList.add('active');
                    prevBtn.disabled = state.currentStep === 1;
                    nextBtn.disabled = (state.currentStep === 1 && state.selectedHallIds.size === 0) || (state.currentStep === steps.length);
                    nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠ';
                    nextBtn.classList.toggle('hidden', state.currentStep === steps.length);

                    if (state.currentStep === 1) renderHallsList();
                    if (state.currentStep === 2) renderStudentList();
                    if (state.currentStep === 3) renderDistributionView();
                    if (state.currentStep === 4) renderExportView();
                    if (state.currentStep === 5) renderAbsenceView();
                };

                const renderStepper = () => {
                    stepperContainer.innerHTML = steps.map(step => {
                        const isActive = state.currentStep === step.id;
                        const isDone = state.currentStep > step.id;
                        const baseClasses = 'flex items-center gap-2 transition-all';
                        const activeClasses = 'text-sky-600 font-bold';
                        const doneClasses = 'text-green-600';
                        let html = `<div class="${baseClasses} ${isActive ? activeClasses : (isDone ? doneClasses : 'text-gray-400')}">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center border-2 ${isActive ? 'border-sky-600 bg-sky-100' : (isDone ? 'border-green-600 bg-green-100' : 'border-gray-300')}">
                                ${isDone ? 'âœ“' : step.id}
                            </div>
                            <span class="hidden md:block">${step.name}</span>
                        </div>`;
                        if (step.id < steps.length) {
                            html += `<div class="flex-1 h-0.5 ${(isDone || (isActive && state.selectedHallIds.size > 0)) ? 'bg-green-600' : 'bg-gray-300'}"></div>`;
                        }
                        return html;
                    }).join('');
                };

                const checkIfSeatingChartExists = (hallId) => {
                    for (const key of state.seatingChart.keys()) {
                        if (key.startsWith(hallId + ':')) { return true; }
                    }
                    return false;
                };

                const renderHallsList = () => {
                    if(state.halls.length === 0) {
                        hallsListContainer.innerHTML = `<p class="text-slate-400 text-center col-span-full mt-8">Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ù‚Ø§Ø¹Ø§Øª Ø¨Ø¹Ø¯. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡.</p>`;
                    } else {
                        hallsListContainer.innerHTML = state.halls.map(hall => {
                            const isSelected = state.selectedHallIds.has(hall.id);
                            const hasChart = checkIfSeatingChartExists(hall.id);
                            return `
                            <div class="border rounded-lg p-4 shadow transition flex flex-col ${isSelected ? 'border-sky-500 ring-2 ring-sky-200' : 'bg-white'}">
                                <div class="flex-grow">
                                    <h3 class="font-bold text-lg">${hall.name}</h3>
                                    <p class="text-sm text-slate-600">${hall.location || 'Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'}</p>
                                    <p class="text-sm text-slate-500">Ø§Ù„ØµÙÙˆÙ: ${hall.rows} | Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª: ${hall.sector1Name}, ${hall.sector2Name}</p>
                                    <p class="text-sm text-slate-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯: ${hall.rows * (hall.sector1Cols + hall.sector2Cols)}</p>
                                </div>
                                <div class="flex gap-2 mt-4 pt-4 border-t">
                                    <button onclick="window.toggleHallSelection(${hall.id})" class="flex-1 text-sm ${isSelected ? 'bg-red-500' : 'bg-green-500'} text-white font-semibold py-1 px-2 rounded hover:bg-green-600">
                                        ${isSelected ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯' : 'ØªØ­Ø¯ÙŠØ¯'}
                                    </button>
                                    <button onclick="window.editHall(${hall.id})" class="text-sm bg-yellow-400 text-white font-semibold py-1 px-2 rounded hover:bg-yellow-500">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button onclick="window.copyHall(${hall.id})" class="text-sm bg-blue-400 text-white font-semibold py-1 px-2 rounded hover:bg-blue-500">Ù†Ø³Ø®</button>
                                    <button onclick="window.deleteHall(${hall.id})" class="text-sm bg-red-500 text-white font-semibold py-1 px-2 rounded hover:bg-red-600">Ø­Ø°Ù</button>
                                </div>
                                ${hasChart ? `
                                    <div class="mt-2 pt-2 border-t border-dashed">
                                    <button onclick="window.goToAbsenceScanning(${hall.id})" class="w-full text-sm bg-teal-500 text-white font-bold py-2 px-2 rounded hover:bg-teal-600 transition">
                                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨
                                    </button>
                                </div>
                                ` : ''}
                            </div>`;
                        }).join('');
                    }
                    nextBtn.disabled = state.selectedHallIds.size === 0;
                };

                const toggleHallModal = (show, hall = null) => {
                    hallModalBackdrop.classList.toggle('hidden', !show);
                    if (show) {
                        hallForm.reset();
                        if (hall) {
                            hallModalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø©';
                            hallIdInput.value = hall.id;
                            hallNameInput.value = hall.name;
                            hallLocationInput.value = hall.location || '';
                            hallRowsInput.value = hall.rows;
                            hallSector1ColsInput.value = hall.sector1Cols;
                            hallSector2ColsInput.value = hall.sector2Cols;
                        } else {
                            hallModalTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                            hallIdInput.value = '';
                        }
                    }
                };
                showHallModalBtn.addEventListener('click', () => toggleHallModal(true));
                cancelHallModalBtn.addEventListener('click', () => toggleHallModal(false));

                hallForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const hallId = hallIdInput.value ? parseInt(hallIdInput.value) : Date.now();
                    const isEditing = !!hallIdInput.value;
                    const hallData = {
                        id: hallId, name: hallNameInput.value, location: hallLocationInput.value,
                        rows: parseInt(hallRowsInput.value), sector1Cols: parseInt(hallSector1ColsInput.value),
                        sector2Cols: parseInt(hallSector2ColsInput.value), disabledSeats: new Set()
                    };
                    const existingIndex = state.halls.findIndex(h => h.id === hallData.id);
                    if (isEditing) {
                        const oldHall = state.halls[existingIndex];
                        hallData.sector1Name = oldHall.sector1Name;
                        hallData.sector2Name = oldHall.sector2Name;
                        hallData.disabledSeats = oldHall.disabledSeats;
                        state.halls[existingIndex] = hallData;
                    } else {
                        let maxSectorNum = 0;
                        state.halls.forEach(h => {
                            [h.sector1Name, h.sector2Name].forEach(sectorName => {
                                if (sectorName) {
                                    const sectorMatch = sectorName.match(/(\d+)/);
                                    if (sectorMatch) {
                                        const num = parseInt(sectorMatch[1], 10);
                                        if (num > maxSectorNum) maxSectorNum = num;
                                    }
                                }
                            });
                        });
                        hallData.sector1Name = `Ù‚Ø·Ø§Ø¹ (${maxSectorNum + 1})`;
                        hallData.sector2Name = `Ù‚Ø·Ø§Ø¹ (${maxSectorNum + 2})`;
                        state.halls.push(hallData);
                    }
                    toggleHallModal(false);
                    saveStateToLocalStorage();
                    updateUI();
                });

                window.toggleHallSelection = (id) => {
                    if (state.selectedHallIds.has(id)) { state.selectedHallIds.delete(id); } else { state.selectedHallIds.add(id); }
                    updateUI();
                };
                window.editHall = (id) => { const hall = state.halls.find(h => h.id === id); if(hall) toggleHallModal(true, hall); };
                window.copyHall = (id) => {
                    const hallToCopy = state.halls.find(h => h.id === id);
                    if (!hallToCopy) return;
                    let newHallName = `${hallToCopy.name} (Ù†Ø³Ø®Ø©)`;
                    const nameMatch = hallToCopy.name.match(/^(.*?)[\s(]*(\d+)\)?$/);
                    let baseName = hallToCopy.name;
                    if (nameMatch) { baseName = nameMatch[1].trim(); }
                    let maxNum = 0;
                    const regex = new RegExp(`^${baseName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}[\\s(]*(\\d+)\\)?$`);
                    state.halls.forEach(h => {
                        const match = h.name.match(regex);
                        if (match) {
                            const num = parseInt(match[1], 10);
                            if (num > maxNum) { maxNum = num; }
                        }
                    });
                    newHallName = `${baseName} (${maxNum + 1})`;
                    let maxSectorNum = 0;
                    state.halls.forEach(h => {
                        [h.sector1Name, h.sector2Name].forEach(sectorName => {
                            if (sectorName) {
                                const sectorMatch = sectorName.match(/(\d+)/);
                                if (sectorMatch) {
                                    const num = parseInt(sectorMatch[1], 10);
                                    if (num > maxSectorNum) maxSectorNum = num;
                                }
                            }
                        });
                    });
                    const newHall = {
                        ...hallToCopy, id: Date.now(), name: newHallName,
                        sector1Name: `Ù‚Ø·Ø§Ø¹ (${maxSectorNum + 1})`, sector2Name: `Ù‚Ø·Ø§Ø¹ (${maxSectorNum + 2})`,
                        disabledSeats: new Set(hallToCopy.disabledSeats), 
                    };
                    state.halls.push(newHall);
                    saveStateToLocalStorage();
                    updateUI();
                };
                window.deleteHall = (id) => {
                    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¹Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ù…Ø®Ø·Ø· Ø§Ù„Ø¬Ù„ÙˆØ³ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø§ Ø£ÙŠØ¶Ù‹Ø§.')) {
                        state.halls = state.halls.filter(h => h.id !== id);
                        state.selectedHallIds.delete(id);
                        const newSeatingChart = new Map();
                        state.seatingChart.forEach((value, key) => {
                            if (!key.startsWith(id + ':')) { newSeatingChart.set(key, value); }
                        });
                        state.seatingChart = newSeatingChart;
                        saveStateToLocalStorage();
                        updateUI();
                    }
                };
                window.goToAbsenceScanning = (hallId) => {
                    state.selectedHallIds.clear();
                    state.selectedHallIds.add(hallId);
                    state.currentStep = 5;
                    updateUI();
                };

                const renderStudentList = () => {
                    studentCountSpan.textContent = state.students.length;
                    if (state.students.length === 0) {
                        studentListContainer.innerHTML = `<p class="text-slate-400 text-center mt-8">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯.</p>`;
                        return;
                    }
                    studentListContainer.innerHTML = state.students.map(s => `
                        <div class="p-2 border rounded-md bg-white flex justify-between items-center text-sm">
                            <div><p class="font-bold">${s.name} (${s.id})</p><p class="text-slate-500">${s.class} - ${s.section}</p></div>
                            <button class="text-red-500 hover:text-red-700 font-bold p-1" onclick="window.removeStudent(${s.uid})">âœ•</button>
                        </div>`).join('');
                };
                window.removeStudent = (uid) => { 
                    state.students = state.students.filter(s => s.uid !== uid);
                    const newSeatingChart = new Map();
                    state.seatingChart.forEach((value, key) => {
                        if (value !== uid) { newSeatingChart.set(key, value); }
                    });
                    state.seatingChart = newSeatingChart;
                    saveStateToLocalStorage();
                    renderStudentList(); 
                };
                const processNewStudents = (newStudents) => {
                    const uniqueNewStudents = newStudents.filter(ns => !state.students.some(s => s.id === ns.id));
                    state.students = [...state.students, ...uniqueNewStudents];
                    state.students.sort((a,b) => a.name.localeCompare(b.name));
                    saveStateToLocalStorage();
                    renderStudentList();
                };
                importTextBtn.addEventListener('click', () => {
                    const lines = studentsTextInput.value.trim().split('\n');
                    const newStudents = lines.map((line, index) => {
                        const parts = line.split(',').map(p => p.trim());
                        if (parts.length < 4) return null;
                        return { uid: Date.now() + index, name: parts[0], id: parts[1], class: parts[2], section: parts[3] };
                    }).filter(Boolean);
                    processNewStudents(newStudents);
                    studentsTextInput.value = '';
                });
                excelFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        const newStudents = json.slice(1).map((row, index) => {
                            if(row.length < 4) return null;
                            return { uid: Date.now() + index, name: String(row[0]), id: String(row[1]), class: String(row[2]), section: String(row[3]) };
                        }).filter(Boolean);
                        processNewStudents(newStudents);
                    };
                    reader.readAsArrayBuffer(file);
                });
                tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        tabBtns.forEach(b => { b.classList.remove('border-sky-600', 'text-sky-600'); b.classList.add('text-gray-500'); });
                        btn.classList.add('border-sky-600', 'text-sky-600');
                        btn.classList.remove('text-gray-500');
                        const tabId = btn.getAttribute('data-tab');
                        tabContents.forEach(content => content.classList.toggle('hidden', content.id !== tabId));
                    });
                });

                const renderDistributionView = () => {
                    const assignedStudentUids = new Set([...state.seatingChart.values()]);
                    const unassignedStudents = state.students.filter(s => !assignedStudentUids.has(s.uid));
                    unassignedStudentsContainer.innerHTML = unassignedStudents.map(s => `
                        <div id="student-card-${s.uid}" class="student-card p-2 border rounded-md bg-white flex justify-between items-center text-sm" draggable="true" data-uid="${s.uid}">
                             <div><p class="font-bold">${s.name}</p><p class="text-slate-500">${s.id} - ${s.class} / ${s.section}</p></div>
                        </div>`).join('') || `<p class="text-slate-400 text-center mt-8">ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨.</p>`;
                    multiHallDistributionContainer.innerHTML = '';
                    state.selectedHallIds.forEach(hallId => {
                        const hall = state.halls.find(h => h.id === hallId);
                        if (hall) {
                            const hallContainer = document.createElement('div');
                            hallContainer.className = 'p-4 border rounded-lg bg-gray-50 overflow-x-auto';
                            hallContainer.innerHTML = `
                                <h3 class="font-bold text-xl mb-4 text-center">${hall.name}</h3>
                                <div class="flex gap-8 justify-center">
                                    <div class="text-center">
                                        <h4 class="font-bold text-lg mb-2">${hall.sector1Name}</h4>
                                        <div id="selector-container-${hall.id}-1" class="flex gap-2 justify-center mb-2"></div>
                                        <div id="dist-grid-${hall.id}-1" class="grid gap-2"></div>
                                     </div>
                                    <div class="text-center">
                                        <h4 class="font-bold text-lg mb-2">${hall.sector2Name}</h4>
                                        <div id="selector-container-${hall.id}-2" class="flex gap-2 justify-center mb-2"></div>
                                        <div id="dist-grid-${hall.id}-2" class="grid gap-2"></div>
                                     </div>
                                </div>`;
                            multiHallDistributionContainer.appendChild(hallContainer);
                            renderSectorGrid(document.getElementById(`dist-grid-${hall.id}-1`), hall, 1);
                            renderSectorGrid(document.getElementById(`dist-grid-${hall.id}-2`), hall, 2);
                            renderColumnSelectors(document.getElementById(`selector-container-${hall.id}-1`), hall, 1);
                            renderColumnSelectors(document.getElementById(`selector-container-${hall.id}-2`), hall, 2);
                        }
                    });
                    addDragAndDropListeners();
                };

                const renderColumnSelectors = (container, hall, sector) => {
                    const uniqueClasses = [...new Set(state.students.map(s => s.class))];
                    const cols = sector === 1 ? hall.sector1Cols : hall.sector2Cols;
                    const colOffset = sector === 1 ? 0 : hall.sector1Cols;
                    container.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
                    for (let c = 0; c < cols; c++) {
                        const actualCol = c + colOffset;
                        const columnId = `${hall.id}:${actualCol}`;
                        const select = document.createElement('select');
                        select.className = 'text-xs border rounded-md p-1';
                        select.dataset.columnId = columnId;
                        select.innerHTML = `<option value="">Ø£ÙŠ ØµÙ</option>` + uniqueClasses.map(cls => `<option value="${cls}" ${state.columnClassAssignments.get(columnId) === cls ? 'selected' : ''}>${cls}</option>`).join('');
                        select.addEventListener('change', (e) => {
                            const selectedClass = e.target.value;
                            if (selectedClass) { state.columnClassAssignments.set(columnId, selectedClass); } else { state.columnClassAssignments.delete(columnId); }
                            saveStateToLocalStorage();
                        });
                        container.appendChild(select);
                    }
                };
                
                const renderSectorGrid = (gridContainer, hall, sector) => {
                    gridContainer.innerHTML = '';
                    const cols = sector === 1 ? hall.sector1Cols : hall.sector2Cols;
                    const colOffset = sector === 1 ? 0 : hall.sector1Cols;
                    gridContainer.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
                    for (let r = 0; r < hall.rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const actualCol = c + colOffset;
                            const seatId = `${hall.id}:${r}-${actualCol}`;
                            const seat = document.createElement('div');
                            seat.className = 'seat droppable-seat aspect-square border-2 border-dashed border-gray-300 rounded-md p-1 bg-gray-100 overflow-hidden min-w-[80px] cursor-pointer';
                            seat.dataset.seatId = seatId;
                            const studentUid = getStudentUidBySeatId(seatId);
                            if (hall.disabledSeats.has(seatId)) {
                                seat.classList.add('disabled');
                            } else if (studentUid) {
                                const student = state.students.find(s => s.uid === studentUid);
                                seat.classList.add('occupied');
                                seat.innerHTML = `<div class="student-card w-full h-full flex flex-col justify-center items-center text-center" draggable="true" data-uid="${student.uid}" data-from-seat-id="${seatId}">
                                        <p class="font-bold text-xs leading-tight">${student.name}</p>
                                        <p class="text-slate-600 text-[10px]">${student.id}</p>
                                        <p class="text-sky-700 font-semibold text-[10px] mt-1">${student.class} / ${student.section}</p>
                                        <div class="qr-code-container" id="qrcode-${seatId.replace(/:/g, '-')}"></div>
                                     </div>`;
                                if(hasConflict(seatId)) seat.classList.add('conflict');
                            }
                            seat.addEventListener('click', () => { if (!getStudentUidBySeatId(seatId)) { toggleSeatDisabled(seatId); } });
                            gridContainer.appendChild(seat);
                            if (studentUid) {
                                const student = state.students.find(s => s.uid === studentUid);
                                // Ø¥Ù†Ø´Ø§Ø¡ QR Code Ø¨Ø­Ø¬Ù… Ø«Ø§Ø¨Øª
                                const qrContainer = document.getElementById(`qrcode-${seatId.replace(/:/g, '-')}`);
                                if (qrContainer) {
                                    qrContainer.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                                    new QRCode(qrContainer, {
                                        text: student.id.toString(),
                                        width: 60,
                                        height: 60,
                                        colorDark: "#000000",
                                        colorLight: "#ffffff",
                                        correctLevel: QRCode.CorrectLevel.H
                                    });
                                }
                            }
                        }
                    }
                };
                
                const toggleSeatDisabled = (seatId) => {
                    const [hallIdStr] = seatId.split(':');
                    const hallId = parseInt(hallIdStr);
                    const hall = state.halls.find(h => h.id === hallId);
                    if (!hall) return;
                    if (hall.disabledSeats.has(seatId)) { hall.disabledSeats.delete(seatId); } else { hall.disabledSeats.add(seatId); }
                    saveStateToLocalStorage();
                    renderDistributionView();
                };

                const addDragAndDropListeners = () => {
                    document.querySelectorAll('.student-card').forEach(card => {
                        card.addEventListener('dragstart', e => {
                            e.dataTransfer.setData('text/plain', e.target.closest('.student-card').dataset.uid);
                            e.dataTransfer.setData('fromSeatId', e.target.closest('.student-card').dataset.fromSeatId || '');
                            setTimeout(() => e.target.classList.add('opacity-50'), 0);
                        });
                        card.addEventListener('dragend', e => e.target.classList.remove('opacity-50'));
                    });
                    document.querySelectorAll('.droppable-seat').forEach(seat => {
                        seat.addEventListener('dragover', e => {
                            e.preventDefault();
                            if(!seat.classList.contains('disabled') && !seat.querySelector('.student-card')) seat.classList.add('droppable-hover');
                        });
                        seat.addEventListener('dragleave', e => e.target.closest('.droppable-seat').classList.remove('droppable-hover'));
                        seat.addEventListener('drop', e => {
                            e.preventDefault();
                            const seatEl = e.target.closest('.droppable-seat');
                            seatEl.classList.remove('droppable-hover');
                            const studentUid = parseInt(e.dataTransfer.getData('text/plain'), 10);
                            const fromSeatId = e.dataTransfer.getData('fromSeatId');
                            const toSeatId = seatEl.dataset.seatId;
                            const [hallIdStr] = toSeatId.split(':');
                            const hall = state.halls.find(h => h.id === parseInt(hallIdStr));
                            if (hall.disabledSeats.has(toSeatId) && !getStudentUidBySeatId(toSeatId)) { hall.disabledSeats.delete(toSeatId); }
                            if (fromSeatId) state.seatingChart.delete(fromSeatId);
                            state.seatingChart.set(toSeatId, studentUid);
                            saveStateToLocalStorage();
                            renderDistributionView();
                        });
                    });
                };

                const getStudentUidBySeatId = (seatId) => state.seatingChart.get(seatId);
                const hasConflict = (seatId) => {
                    const studentUid = getStudentUidBySeatId(seatId);
                    if (!studentUid) return false;
                    const student = state.students.find(s => s.uid === studentUid);
                    if (!student) return false;
                    const [hallId, coords] = seatId.split(':');
                    const [r, c] = coords.split('-').map(Number);
                    const neighbors = [ [r, c - 1], [r, c + 1] ];
                    for (const [nr, nc] of neighbors) {
                        const neighborSeatId = `${hallId}:${nr}-${nc}`;
                        const neighborUid = getStudentUidBySeatId(neighborSeatId);
                        if (neighborUid) {
                            const neighbor = state.students.find(s => s.uid === neighborUid);
                            if (neighbor && neighbor.class === student.class) return true;
                        }
                    }
                    return false;
                };
                
                resetDistributionBtn.addEventListener('click', () => { 
                    state.seatingChart.clear();
                    state.columnClassAssignments.clear();
                    saveStateToLocalStorage();
                    renderDistributionView(); 
                });

                autoDistributeBtn.addEventListener('click', () => {
                    state.seatingChart.clear();
                    const allColumns = [];
                    const sortedHallIds = Array.from(state.selectedHallIds).sort((a, b) => a - b);
                    sortedHallIds.forEach(hallId => {
                        const hall = state.halls.find(h => h.id === hallId);
                        if (hall) {
                            for (let c = 0; c < (hall.sector1Cols + hall.sector2Cols); c++) {
                                const column = [];
                                for (let r = 0; r < hall.rows; r++) {
                                    const seatId = `${hall.id}:${r}-${c}`;
                                    if (!hall.disabledSeats.has(seatId)) { column.push(seatId); }
                                }
                                if (column.length > 0) allColumns.push({ id: `${hall.id}:${c}`, seats: column });
                            }
                        }
                    });
                    const studentsByClass = state.students.reduce((acc, student) => {
                        if (!acc[student.class]) acc[student.class] = [];
                        acc[student.class].push(student);
                        return acc;
                    }, {});
                    const sortedClasses = Object.keys(studentsByClass).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
                    sortedClasses.forEach(className => {
                        studentsByClass[className].sort((a, b) => parseInt(a.id, 10) - parseInt(b.id, 10));
                    });
                    const placementCounters = sortedClasses.reduce((acc, val) => ({...acc, [val]: 0}), {});
                    allColumns.forEach(column => {
                        const assignedClass = state.columnClassAssignments.get(column.id);
                        if (assignedClass && studentsByClass[assignedClass]) {
                            for (const seatId of column.seats) {
                                const studentIndex = placementCounters[assignedClass];
                                if (studentIndex < studentsByClass[assignedClass].length) {
                                    const student = studentsByClass[assignedClass][studentIndex];
                                    state.seatingChart.set(seatId, student.uid);
                                    placementCounters[assignedClass]++;
                                } else { break; }
                            }
                        }
                    });
                    const unassignedColumns = allColumns.filter(c => !state.columnClassAssignments.has(c.id));
                    const remainingStudents = state.students.filter(s => !Array.from(state.seatingChart.values()).includes(s.uid));
                    const remainingStudentsByClass = remainingStudents.reduce((acc, student) => {
                        if (!acc[student.class]) acc[student.class] = [];
                        acc[student.class].push(student);
                        return acc;
                    }, {});
                    const remainingSortedClasses = Object.keys(remainingStudentsByClass).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
                    remainingSortedClasses.forEach(className => {
                        remainingStudentsByClass[className].sort((a, b) => parseInt(a.id, 10) - parseInt(b.id, 10));
                    });
                    let colIndex = 0;
                    let classIndex = 0;
                    const remainingPlacementCounters = remainingSortedClasses.reduce((acc, val) => ({...acc, [val]: 0}), {});
                    while(colIndex < unassignedColumns.length) {
                        const currentColumn = unassignedColumns[colIndex];
                        const currentClassName = remainingSortedClasses[classIndex];
                        if (currentClassName && remainingStudentsByClass[currentClassName]) {
                            const studentsInClass = remainingStudentsByClass[currentClassName];
                            if (remainingPlacementCounters[currentClassName] < studentsInClass.length) {
                                for (const seatId of currentColumn.seats) {
                                    const studentIndex = remainingPlacementCounters[currentClassName];
                                    if (studentIndex < studentsInClass.length) {
                                        const student = studentsInClass[studentIndex];
                                        if (!state.seatingChart.has(seatId)) {
                                             state.seatingChart.set(seatId, student.uid);
                                             remainingPlacementCounters[currentClassName]++;
                                        }
                                    } else { break; }
                                }
                            }
                        }
                        colIndex++;
                        classIndex = (classIndex + 1) % remainingSortedClasses.length;
                        if (state.seatingChart.size >= state.students.length) { break; }
                    }
                    saveStateToLocalStorage();
                    renderDistributionView();
                });

                const renderExportView = () => {
                    exportHeader.querySelector('h2').textContent = `Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØµØ¯ÙŠØ± (${state.selectedHallIds.size} Ù‚Ø§Ø¹Ø§Øª Ù…Ø­Ø¯Ø¯Ø©)`;
                };

                const createPageForPdf = (hall, sector) => {
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page-container';
                    pageContainer.style.fontFamily = "'Cairo', sans-serif";
                    const colOffset = sector === 1 ? 0 : hall.sector1Cols;
                    const cols = sector === 1 ? hall.sector1Cols : hall.sector2Cols;
                    const sectorStudents = [];
                    state.seatingChart.forEach((uid, seatId) => {
                        const [sidHall, sidCoords] = seatId.split(':');
                        if (parseInt(sidHall) === hall.id) {
                            const [r, c] = sidCoords.split('-').map(Number);
                            if (c >= colOffset && c < colOffset + cols) {
                                const student = state.students.find(s => s.uid === uid);
                                if(student) sectorStudents.push(student);
                            }
                        }
                    });
                    const classCounts = sectorStudents.reduce((acc, student) => {
                        acc[student.class] = (acc[student.class] || 0) + 1;
                        return acc;
                    }, {});
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'pdf-header';
                    const bodyDiv = document.createElement('div');
                    bodyDiv.className = 'pdf-body';
                    if(state.backgrounds.use) {
                        if(state.backgrounds.header) {
                            const headerImg = document.createElement('img');
                            headerImg.src = state.backgrounds.header;
                            headerImg.className = 'pdf-bg-image';
                            headerImg.style.opacity = state.backgrounds.headerOpacity;
                            headerDiv.appendChild(headerImg);
                        }
                        if(state.backgrounds.body) {
                            const bodyImg = document.createElement('img');
                            bodyImg.src = state.backgrounds.body;
                            bodyImg.className = 'pdf-bg-image';
                            bodyImg.style.opacity = state.backgrounds.bodyOpacity;
                            bodyDiv.appendChild(bodyImg);
                        }
                    }
                    const headerContent = document.createElement('div');
                    headerContent.className = 'pdf-content flex justify-between items-start mb-6';
                    const leftDiv = document.createElement('div');
                    leftDiv.className = 'w-1/4';
                    const centerDiv = document.createElement('div');
                    centerDiv.className = 'w-1/2 text-center';
                    centerDiv.innerHTML = `<h1 class="text-2xl font-bold">Ù‚Ø§Ø¹Ø© (${hall.name}) - ${hall.location || ''}</h1><h2 class="text-xl font-bold mt-2">${sector === 1 ? hall.sector1Name : hall.sector2Name}</h2>`;
                    const rightDiv = document.createElement('div');
                    rightDiv.className = 'w-1/4 text-right space-y-1';
                    Object.entries(classCounts).forEach(([className, count]) => {
                        const p = document.createElement('p');
                        p.className = 'text-lg font-bold';
                        const toArabicNumerals = (num) => String(num).replace(/[0-9]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);
                        p.textContent = `${className}: ( ${toArabicNumerals(count)} )`;
                        rightDiv.appendChild(p);
                    });
                    headerContent.appendChild(leftDiv);
                    headerContent.appendChild(centerDiv);
                    headerContent.appendChild(rightDiv);
                    headerDiv.appendChild(headerContent);
                    pageContainer.appendChild(headerDiv);
                    const sectorGrid = document.createElement('div');
                    sectorGrid.className = 'grid gap-2 pdf-content';
                    sectorGrid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
                    for (let r = 0; r < hall.rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const actualCol = c + colOffset;
                            const seatId = `${hall.id}:${r}-${actualCol}`;
                            const seat = document.createElement('div');
                            seat.className = 'relative aspect-square border-2 border-black rounded-md p-1 bg-transparent overflow-hidden flex flex-col justify-between items-center text-center';
                            if (hall.disabledSeats.has(seatId)) {
                                seat.innerHTML = `<div class="w-full h-full flex justify-center items-center text-3xl text-gray-400">âœ•</div>`;
                                seat.style.backgroundColor = '#f3f4f6';
                            } else {
                                const studentUid = getStudentUidBySeatId(seatId);
                                if (studentUid) {
                                    const student = state.students.find(s => s.uid === studentUid);
                                    const safeSeatId = seatId.replace(/:/g, '-');
                                    seat.innerHTML = `<div class="w-full flex-grow flex flex-col justify-start items-center">
                                                     <p class="font-black text-lg leading-tight">${student.name}</p>
                                                     <p class="font-bold text-slate-800 text-sm">${student.id}</p>
                                                     <p class="font-bold text-slate-800 text-xs mt-1">${student.class} (${student.section})</p>
                                                    </div>
                                                    <div class="pdf-qr-code" id="pdf-qrcode-${safeSeatId}"></div>`;
                                }
                            }
                            sectorGrid.appendChild(seat);
                        }
                    }
                    bodyDiv.appendChild(sectorGrid);
                    pageContainer.appendChild(bodyDiv);
                    for (let r = 0; r < hall.rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const actualCol = c + colOffset;
                            const seatId = `${hall.id}:${r}-${actualCol}`;
                            const studentUid = getStudentUidBySeatId(seatId);
                            if (studentUid) {
                                const student = state.students.find(s => s.uid === studentUid);
                                const safeSeatId = seatId.replace(/:/g, '-');
                                const qrElement = pageContainer.querySelector(`#pdf-qrcode-${safeSeatId}`);
                                if(qrElement && student) {
                                    qrElement.innerHTML = '';
                                     new QRCode(qrElement, {
                                        text: student.id.toString(),
                                        width: 80,
                                        height: 80,
                                        colorDark: "#000000",
                                        colorLight: "#ffffff",
                                        correctLevel: QRCode.CorrectLevel.M
                                    });
                                }
                            }
                        }
                    }
                    return pageContainer;
                };

                const handleBgUpload = (e, type) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => { state.backgrounds[type] = event.target.result; };
                    reader.readAsDataURL(file);
                };
                useBackgroundsToggle.addEventListener('change', (e) => {
                    state.backgrounds.use = e.target.checked;
                    backgroundInputs.classList.toggle('hidden', !e.target.checked);
                });
                headerBgInput.addEventListener('change', (e) => handleBgUpload(e, 'header'));
                bodyBgInput.addEventListener('change', (e) => handleBgUpload(e, 'body'));
                headerOpacitySlider.addEventListener('input', (e) => {
                    state.backgrounds.headerOpacity = e.target.value;
                    headerOpacityValue.textContent = Math.round(e.target.value * 100);
                });
                bodyOpacitySlider.addEventListener('input', (e) => {
                    state.backgrounds.bodyOpacity = e.target.value;
                    bodyOpacityValue.textContent = Math.round(e.target.value * 100);
                });
                previewPdfBtn.addEventListener('click', async () => {
                    if (state.selectedHallIds.size === 0) { showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù‚Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©.'); return; }
                    const firstHallId = Array.from(state.selectedHallIds)[0];
                    const hall = state.halls.find(h => h.id === firstHallId);
                    previewContent.innerHTML = '';
                    const pageContent = createPageForPdf(hall, 1);
                    document.body.appendChild(pageContent);
                    const canvas = await html2canvas(pageContent, { scale: 1, useCORS: true });
                    canvas.style.width = '100%';
                    canvas.style.height = 'auto';
                    previewContent.appendChild(canvas);
                    document.body.removeChild(pageContent);
                    previewModalBackdrop.classList.remove('hidden');
                    previewModalBackdrop.classList.add('flex');
                });
                closePreviewModalBtn.addEventListener('click', () => {
                    previewModalBackdrop.classList.add('hidden');
                    previewModalBackdrop.classList.remove('flex');
                });
                const triggerPdfDownload = (pdf, filename) => {
                    try {
                        const blob = pdf.output('blob');
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        setTimeout(() => {
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                        }, 100);
                    } catch (e) {
                        console.error("Error triggering PDF download:", e);
                        showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù.");
                    }
                };
                exportChartPdfBtn.addEventListener('click', async () => {
                    if (state.selectedHallIds.size === 0) { showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù‚Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'); return; }
                    
                    const sortedHallIds = Array.from(state.selectedHallIds).sort((a,b) => a - b);
                    const totalPages = sortedHallIds.length * 2;
                    let pagesProcessed = 0;

                    updateProgress(0, totalPages, 'Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø§Øª...');
                    await new Promise(resolve => setTimeout(resolve, 50));

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                    let isFirstPage = true;

                    for (const hallId of sortedHallIds) {
                        const hall = state.halls.find(h => h.id === hallId);
                        if (!hall) continue;
                        for (const sector of [1, 2]) {
                            if (!isFirstPage) { pdf.addPage(); }
                            const pageContent = createPageForPdf(hall, sector);
                            document.body.appendChild(pageContent);
                            const canvas = await html2canvas(pageContent, { scale: 1.2, useCORS: true });
                            const imgData = canvas.toDataURL('image/png');
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = pdf.internal.pageSize.getHeight();
                            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                            document.body.removeChild(pageContent);
                            isFirstPage = false;

                            pagesProcessed++;
                            updateProgress(pagesProcessed, totalPages, 'Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø§Øª...');
                            await new Promise(resolve => setTimeout(resolve, 20));
                        }
                    }
                    triggerPdfDownload(pdf, `Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¬Ù„ÙˆØ³ Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©.pdf`);
                    updateProgress(totalPages, totalPages);
                });

                exportListPdfBtn.addEventListener('click', async () => {
                    updateProgress(0, 100, 'Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ±...');
                    await new Promise(resolve => setTimeout(resolve, 50));

                    try {
                        const amiriFont = 'AAEAAAARAQAABAAQR0RFRgQsAgsAADhkAAAAHkdQT1Mrk8MkAAA4YAAABJBHU1VCA8+JjwAAEnsAAAMyT1MvMg8SDbEAAAEgAAAAYGNtYXABDQDNAAABnAAAAFRnYXNw//8AAwAAOGAAAAAIZ2x5Zt5TAdwAAARAAAACFGhlYWQY2C8VAAAA4AAAADZoaGVhB7QDNAAAASAAAAAkaG10eCoAlgIAAAGoAAAAGmxvY2ED2AO0AAAEgAAAABhtYXhwARgAMQAAAUgAAAAgbmFtZXV0jHEAAAdMAAABMHBvc3QAAwAAAAAAOWAAAAABAAACAAMDAAABdyNQAAAAAFdyNQAAAAAAAQIAZgABAQAAAAAAAgAAAAEAAAAAAQAAAAEAAAACAAEAAgAAAAEAAQAABUADAAgAAQACAAsAAQAAAAEAAAAAACQAKgBOARQAAQAAAAAAAAAAAAIAAAAEAAEAAgAFAAYABwAIAAkACgALAAwADQAOAA8AEAARABIAEwAUABUAFgAXABgAGQAaABsAHAAdAB4AHwAgACEAIgAjACQBJgEnASgBKQEoAysBLgEvATABMQEyATMBNAE1AUEBTAFNAU4BTwFQAVIDVgNkA2gDbgNvA3ADdAN7A3wDfwOAA4MDiAOHA4sDjAOQA5EDmAOXA5gDmQOaA5sDnAOdA54DnwOgA6EDogOkA6UDpwOpA6oDqgOrA6wDrwOwA7EDsgOzA7QDswO1A7gDugO8A70DvgO/A8ADwQPCg8SDxQPGg8fDyYPJw8pDykPKw8yDzQPNw88DzwPPQ8/D0EPRQ9JD0sPTw9RD1MPVw9hD2MPZQ9oD2kPbQ9wD3MPhQ+MD5kPnw+hD6MPpA+qD7APtQ+2D7oPug/AD8kP0w/VD9sP3Q/fD+EP5g/pD+wP8Q/yD/YAAAAEAJgBEgABARcBJwA3AAYABQAHAAsADwAXABkAHEAAgAAABQAqADQAOQBDAE8AUwBiAGsAdAC7AMQAyQDPANMA3gDtAO4A+wEIAQwBEQEcAa8BrwGnAa4BrwGvAAAAAQAAAAAAAQAAAAAAAQAAAAAAAgAAAAIAAAAHAAMBAQAAAAAAAAAAAAQAAgACACsAJAOWAAAAgADAAIAAAACAAIAAAADAAIAAAACAAIAAAAAAAAAAAAAAAIAAAACAAIAAAAAAAAAAADAzMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//8AAwABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAABAAIAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAgAAAAAAAAAAAAAAAgAAAwADAAQABQAIAAkACgALAAwADQAOAA8AEAARABIAEwAUABUAFwAXABgAGQAaABsAHAAdAB4AHwAgACEAIgAjACQBJgEnASgBKQEoAysBLgEvATABMQEyATMBNAE1AUEBTAFNAU4BTwFQAVIDVgNkA2gDbgNvA3ADdAN7A3wDfwOAA4MDiAOHA4sDjAOQA5EDmAOXA5gDmQOaA5sDnAOdA54DnwOgA6EDogOkA6UDpwOpA6oDqgOrA6wDrwOwA7EDsgOzA7QDswO1A7gDugO8A70DvgO/A8ADwQPCg8SDxQPGg8fDyYPJw8pDykPKw8yDzQPNw88DzwPPQ8/D0EPRQ9JD0sPTw9RD1MPVw9hD2MPZQ9oD2kPbQ9wD3MPhQ+MD5kPnw+hD6MPpA+qD7APtQ+2D7oPug/AD8kP0w/VD9sP3Q/fD+EP5g/pD+wP8Q/yD/YACQAAAAAAAAAAAAAAAAAIAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAUAAQIDBAEIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJAAEAAAAAAAAAAAAABAAECAkHCwUKAwkJBwwGCAcGBAYCBwAAAAAGAAEBAgQCAwEFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAICAgkCAwEIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAgABAgQCAgEABgAAAAAAAAAAAAAAAAAAAAAAAAACAAcAAAAAAAYAAQEEAgQCAgEABwAAAAAAAAAAAAAAAAAAAAAAAAADAAIAAggAAAEAAAAAAAIAAgIDAgIBAQkCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAAAAIAAgAAAAAFAAEAAAAAAAAAAQIDBAEFAAcACgAAAAAAAAABAAEAAgABAAEAAQAAAAEAAAAAAAAAAQAAAAAAAQAAAAIAAQAAAAAAAAAAAAMAAAAAAAAAAQAAAAACAAEAAgABAAEAAwAAAAAABAACAAAAAQAJ//8ABwABAAAAAAAAAAEAAAABAAAAAAAAAAEAAAAAAAAAAgAAAAEAAAAAAAAAAQAAAAQAAQAFAAAABQAGAAcACAADAAQABQAHAAMABAAFAAcAAwAEAAsADgAPABAABQAIAAkACgALAAgACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAk.m';
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();

                        doc.addFileToVFS('Amiri-Regular.ttf', amiriFont);
                        doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
                        doc.setFont('Amiri');
                        doc.setR2L(true);
                        updateProgress(20, 100, 'Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                        const tableData = [];
                        state.seatingChart.forEach((studentUid, seatId) => {
                            const student = state.students.find(s => s.uid === studentUid);
                            if (student) {
                                const [hallId, coords] = seatId.split(':');
                                const hall = state.halls.find(h => h.id === parseInt(hallId));
                                const [r, c] = coords.split('-').map(Number);
                                tableData.push({
                                    seat: `${hall ? hall.name : 'N/A'} | R${r+1}-C${c+1}`,
                                    name: student.name,
                                    id: student.id,
                                    class: student.class,
                                    section: student.section
                                });
                            }
                        });
                        tableData.sort((a, b) => a.name.localeCompare(b.name, 'ar'));

                        const head = [['', 'Ø§Ù„Ø´Ø¹Ø¨Ø©', 'Ø§Ù„ØµÙ', 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ù…Ù‚Ø¹Ø¯ ÙˆØ§Ù„Ù‚Ø§Ø¹Ø©']];
                        const body = tableData.map(row => [
                            '',
                            row.section,
                            row.class,
                            row.id,
                            row.name,
                            row.seat
                        ]);
                        updateProgress(60, 100, 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„...');
                        await new Promise(resolve => setTimeout(resolve, 50));
                        doc.text("Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©", doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                        doc.autoTable({
                            head: head,
                            body: body,
                            startY: 25,
                            styles: {
                                font: 'Amiri',
                                halign: 'right',
                                cellPadding: 2,
                                fontSize: 10,
                            },
                            headStyles: {
                                halign: 'center',
                                fillColor: [41, 128, 185],
                                textColor: 255,
                                fontStyle: 'bold'
                            },
                            columnStyles: {
                                0: {cellWidth: 40}, 
                            }
                        });
                        updateProgress(90, 100, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
                        await new Promise(resolve => setTimeout(resolve, 50));

                        triggerPdfDownload(doc, `Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø­Ø¶ÙˆØ±.pdf`);
                        updateProgress(100, 100);
                    } catch (e) {
                        console.error("Failed to export attendance list:", e);
                        showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙ†ÙŠ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ±.");
                        updateProgress(100, 100);
                    }
                });
                
                const renderAbsenceView = () => {
                    absentCountSpan.textContent = state.absentStudents.length;
                    const hasAbsence = state.absentStudents.length > 0;
                    
                    exportAbsentImgBtn.disabled = !hasAbsence;
                    exportAbsentPdfBtn.disabled = !hasAbsence;
                    exportAbsentWordBtn.disabled = !hasAbsence;
                    if (!hasAbsence) {
                        absentListContainer.innerHTML = `<p class="text-slate-400 text-center mt-8">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ ØºÙŠØ§Ø¨ Ø¨Ø¹Ø¯.</p>`;
                        return;
                    }
                    absentListContainer.innerHTML = state.absentStudents.map(s => {
                        const studentSeat = [...state.seatingChart.entries()].find(([key, val]) => val === s.uid);
                        let seatInfo = 'ØºÙŠØ± Ù…ÙˆØ²Ù‘Ø¹';
                        if(studentSeat) {
                            const [hallId, coords] = studentSeat[0].split(':');
                            const hall = state.halls.find(h => h.id === parseInt(hallId));
                            seatInfo = `${hall ? hall.name : ''} (${coords})`;
                        }
                        return `<div class="p-2 border rounded-md bg-white flex justify-between items-center text-sm">
                            <div><p class="font-bold">${s.name} (${s.id})</p><p class="text-slate-500">${s.class} - ${seatInfo}</p></div>
                            <button class="text-red-500 hover:text-red-700 font-bold p-1" onclick="window.removeAbsentStudent(${s.uid})">âœ•</button>
                        </div>`;
                    }).join('');
                };
                
                window.removeAbsentStudent = (uid) => {
                    state.absentStudents = state.absentStudents.filter(s => s.uid !== uid);
                    renderAbsenceView();
                };

                const onScanSuccess = (decodedText, decodedResult) => {
                    const examNumber = decodedText;
                    if (state.absentStudents.some(s => s.id === examNumber)) {
                        showScanFeedback(`Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ø±Ù‚Ù… ${examNumber} Ù…Ø³Ø¬Ù„ ÙƒØºØ§Ø¦Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„.`, 'fail');
                        return;
                    }
                    const student = state.students.find(s => s.id === examNumber);
                    if (student) {
                        state.absentStudents.push(student);
                        renderAbsenceView();
                        showScanFeedback(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨: ${student.name} (${student.id})`, 'success');
                    } else {
                        showScanFeedback(`Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠ ${examNumber} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø·Ù„Ø§Ø¨.`, 'fail');
                    }
                };
                const onScanFailure = (error) => { /* Ignore */ };
                const showScanFeedback = (message, type) => {
                    scanFeedbackDiv.innerHTML = `<span class="${type}">${message}</span>`;
                    setTimeout(() => { scanFeedbackDiv.innerHTML = ''; }, 3000);
                };

                startScanBtn.addEventListener('click', () => {
                    html5QrCode = new Html5Qrcode("reader");
                    startScanBtn.classList.add('hidden');
                    stopScanBtn.classList.remove('hidden');
                    scanFeedbackDiv.innerHTML = '';
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .catch(err => {
                        showAlert(`Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ${err}`);
                        stopScanBtn.click();
                    });
                });
                stopScanBtn.addEventListener('click', () => {
                    if (html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.stop().then(() => {
                            startScanBtn.classList.remove('hidden');
                            stopScanBtn.classList.add('hidden');
                        }).catch(err => console.error("Failed to stop QR scanner.", err));
                    }
                });

                // --- ABSENCE EXPORT FUNCTIONS ---
                const getAbsenceDataForExport = () => {
                    const data = state.absentStudents.map(student => {
                        // Find sector info if possible
                        let sectorName = "";
                        let hall = null;
                        const studentSeat = [...state.seatingChart.entries()].find(([key, val]) => val === student.uid);
                        if(studentSeat) {
                             const [hallId, coords] = studentSeat[0].split(':');
                             const [r, c] = coords.split('-').map(Number);
                             hall = state.halls.find(h => h.id === parseInt(hallId));
                             if(hall) {
                                  sectorName = c < hall.sector1Cols ? hall.sector1Name : hall.sector2Name;
                             }
                        }
                        
                        // Format date
                        const today = new Date();
                        const dateStr = today.toLocaleDateString('ar-EG');
                        const dayName = today.toLocaleDateString('ar-EG', { weekday: 'long' });
                        return {
                            className: student.class,
                            dateFull: `${dayName} ${dateStr}`,
                            name: student.name,
                            section: student.section,
                            id: student.id,
                            sector: sectorName,
                            hallName: hall ? hall.name : ""
                        };
                    });
                     // Sort by name
                    return data.sort((a,b) => a.name.localeCompare(b.name, 'ar'));
                };

                // 1. Export Image (Existing logic modified)
                exportAbsentImgBtn.addEventListener('click', async () => {
                    const statusDiv = document.getElementById('scan-feedback');
                    statusDiv.innerHTML = `<span class="success">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©...</span>`;

                    const reportContainer = document.createElement('div');
                    reportContainer.className = 'p-10 bg-white';
                    reportContainer.style.fontFamily = "'Cairo', sans-serif";
                    reportContainer.style.width = '800px';
                    reportContainer.style.position = 'absolute';
                    reportContainer.style.left = '-9999px';
                    reportContainer.style.direction = 'rtl';

                    let tableHtml = `<h1 class="text-2xl font-bold text-center mb-6">Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø©</h1>
                                     <table class="w-full text-base text-right" style="border-collapse: collapse;">
                                        <thead class="text-gray-700 uppercase bg-gray-200">
                                            <tr>
                                                <th class="px-4 py-3 border border-gray-400">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                                <th class="px-4 py-3 border border-gray-400">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠ</th>
                                                <th class="px-4 py-3 border border-gray-400">Ø§Ù„ØµÙ</th>
                                                <th class="px-4 py-3 border border-gray-400">Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                    state.absentStudents.forEach(student => {
                        tableHtml += `<tr class="bg-white border-b">
                                        <td class="px-4 py-2 font-medium text-gray-900 border border-gray-300">${student.name}</td>
                                        <td class="px-4 py-2 border border-gray-300">${student.id}</td>
                                        <td class="px-4 py-2 border border-gray-300">${student.class}</td>
                                        <td class="px-4 py-2 border border-gray-300">${student.section}</td>
                                      </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    reportContainer.innerHTML = tableHtml;
                    document.body.appendChild(reportContainer);

                    try {
                        const canvas = await html2canvas(reportContainer, { scale: 2, useCORS: true });
                        const imgData = canvas.toDataURL('image/png');
                        const link = document.createElement('a');
                        link.href = imgData;
                        link.download = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØºÙŠØ§Ø¨.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        statusDiv.innerHTML = `<span class="success">ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!</span>`;
                    } catch(err) {
                        console.error("Error exporting image:", err);
                        showAlert("ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©.");
                    } finally {
                        document.body.removeChild(reportContainer);
                        setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
                    }
                });

                // 2. Export Word (MODIFIED AS REQUESTED)
                exportAbsentWordBtn.addEventListener('click', () => {
                     const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, AlignmentType, Header } = docx;
                     const absenceData = getAbsenceDataForExport();
                     
                     // Determine Hall Name for Title (using the first record found)
                     const firstRecord = absenceData[0];
                     const hallTitle = firstRecord ? (firstRecord.hallName || "") : "";
                     
                     // Table Header
                     const tableHeaderRow = new TableRow({
                         children: [
                             new TableCell({ children: [new Paragraph({text: "Ø§Ù„ØªÙˆÙ‚ÙŠØ¹", alignment: AlignmentType.CENTER})], width: { size: 10, type: WidthType.PERCENTAGE } }),
                             new TableCell({ children: [new Paragraph({text: "Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨", alignment: AlignmentType.CENTER})], width: { size: 10, type: WidthType.PERCENTAGE } }),
                             new TableCell({ children: [new Paragraph({text: "Ø±Ù‚Ù…Ù‡", alignment: AlignmentType.CENTER})], width: { size: 10, type: WidthType.PERCENTAGE } }),
                             new TableCell({ children: [new Paragraph({text: "Ø§Ù„Ø´Ø¹Ø¨Ø©", alignment: AlignmentType.CENTER})], width: { size: 10, type: WidthType.PERCENTAGE } }),
                             new TableCell({ children: [new Paragraph({text: "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨", alignment: AlignmentType.CENTER})], width: { size: 30, type: WidthType.PERCENTAGE } }),
                             // Separated Class and Date
                             new TableCell({ children: [new Paragraph({text: "Ø§Ù„ØµÙ", alignment: AlignmentType.CENTER})], width: { size: 10, type: WidthType.PERCENTAGE } }),
                             new TableCell({ children: [new Paragraph({text: "Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®", alignment: AlignmentType.CENTER})], width: { size: 20, type: WidthType.PERCENTAGE } }),
                         ]
                     });

                     // Table Rows
                     const tableRows = absenceData.map(d => {
                         return new TableRow({
                             children: [
                                 new TableCell({ children: [new Paragraph("")] }), // Signature
                                 new TableCell({ children: [new Paragraph("")] }), // Monitor
                                 new TableCell({ children: [new Paragraph({text: String(d.id), alignment: AlignmentType.CENTER})] }),
                                 new TableCell({ children: [new Paragraph({text: d.section, alignment: AlignmentType.CENTER})] }),
                                 new TableCell({ children: [new Paragraph({text: d.name, alignment: AlignmentType.RIGHT})] }),
                                 // Data for separate columns
                                 new TableCell({ children: [new Paragraph({text: d.className, alignment: AlignmentType.CENTER})] }),
                                 new TableCell({ children: [new Paragraph({text: d.dateFull, alignment: AlignmentType.CENTER})] }),
                             ]
                         });
                     });

                     const doc = new Document({
                         sections: [{
                             properties: {},
                             children: [
                                 new Paragraph({
                                     text: `Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø© // Ù‚Ø§Ø¹Ø©: (${hallTitle})`,
                                     heading: "Heading1",
                                     alignment: AlignmentType.CENTER,
                                     bidirectional: true
                                 }),
                                 new Paragraph({ text: "" }), // Spacer
                                 new Table({
                                     columnWidths: [1000, 1000, 1000, 1000, 3000, 1000, 2000], // Adjusted Widths for 7 columns
                                     rows: [tableHeaderRow, ...tableRows],
                                     width: { size: 100, type: WidthType.PERCENTAGE }
                                 })
                             ]
                         }]
                     });

                     Packer.toBlob(doc).then(blob => {
                         saveAs(blob, "Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª.docx");
                     });
                });

                // 3. Export PDF
                exportAbsentPdfBtn.addEventListener('click', async () => {
                     const amiriFont = 'AAEAAAARAQAABAAQR0RFRgQsAgsAADhkAAAAHkdQT1Mrk8MkAAA4YAAABJBHU1VCA8+JjwAAEnsAAAMyT1MvMg8SDbEAAAEgAAAAYGNtYXABDQDNAAABnAAAAFRnYXNw//8AAwAAOGAAAAAIZ2x5Zt5TAdwAAARAAAACFGhlYWQY2C8VAAAA4AAAADZoaGVhB7QDNAAAASAAAAAkaG10eCoAlgIAAAGoAAAAGmxvY2ED2AO0AAAEgAAAABhtYXhwARgAMQAAAUgAAAAgbmFtZXV0jHEAAAdMAAABMHBvc3QAAwAAAAAAOWAAAAABAAACAAMDAAABdyNQAAAAAFdyNQAAAAAAAQIAZgABAQAAAAAAAgAAAAEAAAAAAQAAAAEAAAACAAEAAgAAAAEAAQAABQADAAgAAQACAAsAAQAAAAEAAAAAACQAKgBOARQAAQAAAAAAAAAAAAIAAAAEAAEAAgAFAAYABwAIAAkACgALAAwADQAOAA8AEAARABIAEwAUABUAFwAXABgAGQAaABsAHAAdAB4AHwAgACEAIgAjACQBJgEnASgBKQEoAysBLgEvATABMQEyATMBNAE1AUEBTAFNAU4BTwFQAVIDVgNkA2gDbgNvA3ADdAN7A3wDfwOAA4MDiAOHA4sDjAOQA5EDmAOXA5gDmQOaA5sDnAOdA54DnwOgA6EDogOkA6UDpwOpA6oDqgOrA6wDrwOwA7EDsgOzA7QDswO1A7gDugO8A70DvgO/A8ADwQPCg8SDxQPGg8fDyYPJw8pDykPKw8yDzQPNw88DzwPPQ8/D0EPRQ9JD0sPTw9RD1MPVw9hD2MPZQ9oD2kPbQ9wD3MPhQ+MD5kPnw+hD6MPpA+qD7APtQ+2D7oPug/AD8kP0w/VD9sP3Q/fD+EP5g/pD+wP8Q/yD/YACQAAAAAAAAAAAAAAAAAIAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAUAAQIDBAEIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJAAEAAAAAAAAAAAAABAAECAkHCwUKAwkJBwwGCAcGBAYCBwAAAAAGAAEBAgQCAwEFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAICAgkCAwEIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAgABAgQCAgEABgAAAAAAAAAAAAAAAAAAAAAAAAACAAcAAAAAAAYAAQEEAgQCAgEABwAAAAAAAAAAAAAAAAAAAAAAAAADAAIAAggAAAEAAAAAAAIAAgIDAgIBAQkCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAAAAIAAgAAAAAFAAEAAAAAAAAAAQIDBAEFAAcACgAAAAAAAAABAAEAAgABAAEAAQAAAAEAAAAAAAAAAQAAAAAAAQAAAAIAAQAAAAAAAAAAAAMAAAAAAAAAAQAAAAACAAEAAgABAAEAAwAAAAAABAACAAAAAQAJ//8ABwABAAAAAAAAAAEAAAABAAAAAAAAAAEAAAAAAAAAAgAAAAEAAAAAAAAAAQAAAAQAAQAFAAAABQAGAAcACAADAAQABQAHAAMABAAFAAcAAwAEAAsADgAPABAABQAIAAkACgALAAgACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAAkACQAIAk.m';
                     const { jsPDF } = window.jspdf;
                     const doc = new jsPDF();
                     doc.addFileToVFS('Amiri-Regular.ttf', amiriFont);
                     doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
                     doc.setFont('Amiri');
                     doc.setR2L(true);
                     const absenceData = getAbsenceDataForExport();
                     
                     // Use Separated Data for PDF as well? The request was specifically for Word, but let's keep PDF clean or similar
                     // Currently PDF uses classDate string.
                     const head = [['Ø§Ù„ØªÙˆÙ‚ÙŠØ¹', 'Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨', 'Ø±Ù‚Ù…Ù‡', 'Ø§Ù„Ø´Ø¹Ø¨Ø©', 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨', 'Ø§Ù„ØµÙ ÙˆØ§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®']];
                     const body = absenceData.map(d => [
                         '', // Signature
                         '', // Monitor
                         d.id,
                         d.section,
                         d.name,
                         `${d.className} - ${d.dateFull}` // Combined for PDF as per previous logic unless requested otherwise, but let's keep it consistent
                     ]);
                     
                     // Title handling for PDF
                     const firstRecord = absenceData[0];
                     const hallTitle = firstRecord ? (firstRecord.hallName || "") : "";
                     
                     doc.text(`Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø© // Ù‚Ø·Ø§Ø¹ Ø±Ù‚Ù… (${hallTitle})`, doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                     doc.autoTable({
                        head: head,
                        body: body,
                        startY: 30,
                        theme: 'grid',
                        styles: {
                            font: 'Amiri',
                            halign: 'center',
                            valign: 'middle',
                            lineWidth: 0.1,
                            lineColor: [0, 0, 0]
                        },
                        headStyles: {
                            fillColor: [240, 240, 240],
                            textColor: [0, 0, 0],
                            fontStyle: 'bold',
                            lineWidth: 0.1
                        },
                        columnStyles: {
                            5: { cellWidth: 50 }, // Class/Date
                            4: { cellWidth: 60 }, // Name
                        }
                    });

                     doc.save("Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª.pdf");
                });

                const navigate = (direction) => {
                    if (direction === 'next' && state.currentStep === 1 && state.selectedHallIds.size === 0) {
                        showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù‚Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.');
                        return;
                    }
                    const newStep = state.currentStep + (direction === 'next' ? 1 : -1);
                    if (newStep > 0 && newStep <= steps.length) {
                        if(state.currentStep === 5 && html5QrCode && html5QrCode.isScanning) {
                            stopScanBtn.click();
                        }
                        state.currentStep = newStep;
                        updateUI();
                    }
                };
                const showAlert = (message) => {
                    const alertBox = document.getElementById('custom-alert');
                    const alertMessage = document.getElementById('alert-message');
                    alertMessage.textContent = message;
                    alertBox.classList.remove('hidden');
                    setTimeout(() => alertBox.classList.add('hidden'), 3000);
                };

                nextBtn.addEventListener('click', () => navigate('next'));
                prevBtn.addEventListener('click', () => navigate('prev'));

                loadStateFromLocalStorage();
                updateUI();
            }
        });
    </script>

<!-- ====== Ø¥Ø¶Ø§ÙØ© ØªØµØ¯ÙŠØ± Word Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª + Ø§Ù„Ø®Ù„Ø§ØµØ© (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø³Ù…ÙŠ) ====== -->
<script>
function exportAbsentWord_File(state){
    const rows1 = [
        ["ØªØ³Ù„Ø³Ù„","Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨","Ø§Ù„ØµÙ","Ø§Ù„Ø´Ø¹Ø¨Ø©","Ø§Ù„Ù‚Ø§Ø¹Ø©","Ø§Ù„Ù‚Ø·Ø§Ø¹","Ø±Ù‚Ù…Ù‡","Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨","Ø§Ù„ØªÙˆÙ‚ÙŠØ¹"]
    ];
    state.absentStudents.forEach((s,i)=>{
        rows1.push([
            (i+1).toString(),
            s.name,
            s.class,
            s.section,
            s.hall||"",
            s.sector||"",
            s.seat||"",
            "",
            ""
        ]);
    });

    const summaryMap={};
    state.students.forEach(s=>{
        if(!summaryMap[s.class]) summaryMap[s.class]={total:0,absent:0};
        summaryMap[s.class].total++;
    });
    state.absentStudents.forEach(s=>{
        if(summaryMap[s.class]) summaryMap[s.class].absent++;
    });

    const rows2=[["Ø§Ù„Ù…Ø±Ø­Ù„Ø©","Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨","Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨","Ø§Ù„Ø¯ÙØ§ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©"]];
    Object.keys(summaryMap).forEach(k=>{
        rows2.push([
            k,
            summaryMap[k].total.toString(),
            summaryMap[k].absent.toString(),
            (summaryMap[k].total-summaryMap[k].absent).toString()
        ]);
    });

    const doc = new docx.Document({
        sections:[{
            children:[
                new docx.Paragraph({text:"Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø©",alignment:"center",bold:true}),
                new docx.Paragraph({text:"Ø§Ù„ØªØ§Ø±ÙŠØ®: "+new Date().toLocaleDateString('ar-IQ'),alignment:"right"}),
                new docx.Table({rows:rows1.map(r=>new docx.TableRow({children:r.map(c=>new docx.TableCell({children:[new docx.Paragraph(c)]}))}))}),
                new docx.Paragraph(""),
                new docx.Paragraph({text:"Ø®Ù„Ø§ØµØ© Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª",alignment:"center",bold:true}),
                new docx.Table({rows:rows2.map(r=>new docx.TableRow({children:r.map(c=>new docx.TableCell({children:[new docx.Paragraph(c)]}))}))})
            ]
        }]
    });
    docx.Packer.toBlob(doc).then(b=>saveAs(b,"Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª.docx"));
}
</script>

</body>
</html>
