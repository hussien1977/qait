// --- ABSENCE EXPORT FUNCTIONS ---
const getAbsenceDataForExport = () => {
    const data = state.absentStudents.map(student => {
        // الحصول على معلومات القاعة والقطاع
        let hallInfo = "";
        let sectorInfo = "";
        const studentSeat = [...state.seatingChart.entries()].find(([key, val]) => val === student.uid);
        
        if (studentSeat) {
            const [hallId, coords] = studentSeat[0].split(':');
            const hall = state.halls.find(h => h.id === parseInt(hallId));
            if (hall) {
                hallInfo = hall.name;
                
                // إضافة رقم المقعد
                const [r, c] = coords.split('-').map(Number);
                
                // تحديد القطاع بناءً على عمود المقعد
                if (c < hall.sector1Cols) {
                    sectorInfo = hall.sector1Name;
                } else {
                    sectorInfo = hall.sector2Name;
                }
                
                // إضافة معلومات المقعد
                hallInfo += ` (ص${r + 1}، ع${c + 1})`;
            }
        }
        
        // فصل التاريخ والتاريخ اليوم
        const today = new Date();
        const dateStr = today.toLocaleDateString('ar-EG', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        const dayName = today.toLocaleDateString('ar-EG', { weekday: 'long' });
        
        return {
            uid: student.uid,
            name: student.name,
            section: student.section,
            id: student.id,
            class: student.class,
            hall: hallInfo,
            sector: sectorInfo,
            dayName: dayName,
            date: dateStr,
            classDate: `${student.class}\n${dayName}\n${dateStr}`
        };
    });
    
    // ترتيب حسب اسم الطالب
    return data.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
};

// 1. Export Image (Existing logic modified)
exportAbsentImgBtn.addEventListener('click', async () => {
    const statusDiv = document.getElementById('scan-feedback');
    statusDiv.innerHTML = `<span class="success">جاري تحضير الصورة...</span>`;

    const reportContainer = document.createElement('div');
    reportContainer.className = 'p-10 bg-white';
    reportContainer.style.fontFamily = "'Cairo', sans-serif";
    reportContainer.style.width = '800px';
    reportContainer.style.position = 'absolute';
    reportContainer.style.left = '-9999px';
    reportContainer.style.direction = 'rtl';

    let tableHtml = `<h1 class="text-2xl font-bold text-center mb-6">قائمة غيابات الطلبة</h1>
                     <table class="w-full text-base text-right" style="border-collapse: collapse;">
                        <thead class="text-gray-700 uppercase bg-gray-200">
                            <tr>
                                <th class="px-4 py-3 border border-gray-400">اسم الطالب</th>
                                <th class="px-4 py-3 border border-gray-400">الرقم الامتحاني</th>
                                <th class="px-4 py-3 border border-gray-400">الصف</th>
                                <th class="px-4 py-3 border border-gray-400">الشعبة</th>
                            </tr>
                        </thead>
                        <tbody>`;
    
    state.absentStudents.forEach(student => {
        tableHtml += `<tr class="bg-white border-b">
                        <td class="px-4 py-2 font-medium text-gray-900 border border-gray-300">${student.name}</td>
                        <td class="px-4 py-2 border border-gray-300">${student.id}</td>
                        <td class="px-4 py-2 border border-gray-300">${student.class}</td>
                        <td class="px-4 py-2 border border-gray-300">${student.section}</td>
                      </tr>`;
    });
    tableHtml += `</tbody></table>`;
    reportContainer.innerHTML = tableHtml;
    document.body.appendChild(reportContainer);

    try {
        const canvas = await html2canvas(reportContainer, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imgData;
        link.download = 'تقرير_الغياب.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        statusDiv.innerHTML = `<span class="success">تم تصدير الصورة بنجاح!</span>`;
    } catch(err) {
        console.error("Error exporting image:", err);
        showAlert("فشل تصدير الصورة.");
    } finally {
        document.body.removeChild(reportContainer);
        setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
    }
});

// 2. Export Word (Modified - Separated Class and Date, Added Hall)
exportAbsentWordBtn.addEventListener('click', () => {
    const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, AlignmentType } = docx;
    const absenceData = getAbsenceDataForExport();

    // Table Header - فصل الصف والتاريخ وإضافة القاعة
    const tableHeaderRow = new TableRow({
        children: [
            new TableCell({ 
                children: [new Paragraph({
                    text: "التوقيع", 
                    alignment: AlignmentType.CENTER,
                    bidirectional: true
                })], 
                width: { size: 8, type: WidthType.PERCENTAGE } 
            }),
            new TableCell({ 
                children: [new Paragraph({
                    text: "المراقب", 
                    alignment: AlignmentType.CENTER,
                    bidirectional: true
                })], 
                width: { size: 10, type: WidthType.PERCENTAGE } 
            }),
            new TableCell({ 
                children: [new Paragraph({
                    text: "رقمه", 
                    alignment: AlignmentType.CENTER,
                    bidirectional: true
                })], 
                width: { size: 8, type: WidthType.PERCENTAGE } 
            }),
            new TableCell({ 
                children: [new Paragraph({
                    text: "القاعة الامتحانية", 
                    alignment: AlignmentType.CENTER,
                    bidirectional: true
                })], 
                width: { size: 12, type: WidthType.PERCENTAGE } 
            }),
            new TableCell({ 
                children: [new Paragraph({
                    text: "الشعبة", 
                    alignment: AlignmentType.CENTER,
                    bidirectional: true
                })], 
                width: { size: 8, type: WidthType.PERCENTAGE } 
            }),
            new TableCell({ 
                children: [new Paragraph({
                    text: "الصف", 
                    alignment: AlignmentType.CENTER,
                    bidirectional: true
                })], 
                width: { size: 8, type: WidthType.PERCENTAGE } 
            }),
            new TableCell({ 
                children: [new Paragraph({
                    text: "التاريخ", 
                    alignment: AlignmentType.CENTER,
                    bidirectional: true
                })], 
                width: { size: 10, type: WidthType.PERCENTAGE } 
            }),
            new TableCell({ 
                children: [new Paragraph({
                    text: "اسم الطالب الغائب", 
                    alignment: AlignmentType.CENTER,
                    bidirectional: true
                })], 
                width: { size: 36, type: WidthType.PERCENTAGE } 
            }),
        ]
    });

    // Table Rows
    const tableRows = absenceData.map(d => {
        return new TableRow({
            children: [
                new TableCell({ 
                    children: [new Paragraph("")] 
                }), // التوقيع - فارغ للملء
                new TableCell({ 
                    children: [new Paragraph("")] 
                }), // المراقب - فارغ للملء
                new TableCell({ 
                    children: [new Paragraph({
                        text: String(d.id), 
                        alignment: AlignmentType.CENTER,
                        bidirectional: true
                    })] 
                }), // رقم الطالب
                new TableCell({ 
                    children: [new Paragraph({
                        text: d.hall || "غير موزع", 
                        alignment: AlignmentType.CENTER,
                        bidirectional: true
                    })] 
                }), // القاعة الامتحانية
                new TableCell({ 
                    children: [new Paragraph({
                        text: d.section, 
                        alignment: AlignmentType.CENTER,
                        bidirectional: true
                    })] 
                }), // الشعبة
                new TableCell({ 
                    children: [new Paragraph({
                        text: d.class, 
                        alignment: AlignmentType.CENTER,
                        bidirectional: true
                    })] 
                }), // الصف (منفصل)
                new TableCell({ 
                    children: [new Paragraph({
                        text: d.date, 
                        alignment: AlignmentType.CENTER,
                        bidirectional: true
                    })] 
                }), // التاريخ (منفصل)
                new TableCell({ 
                    children: [new Paragraph({
                        text: d.name, 
                        alignment: AlignmentType.RIGHT,
                        bidirectional: true
                    })] 
                }), // اسم الطالب
            ]
        });
    });

    const doc = new Document({
        sections: [{
            properties: {
                page: {
                    margin: {
                        top: 1000,
                        right: 1000,
                        bottom: 1000,
                        left: 1000,
                    }
                }
            },
            children: [
                new Paragraph({
                    text: "قائمة غيابات الطلبة",
                    heading: "Heading1",
                    alignment: AlignmentType.CENTER,
                    bidirectional: true,
                    spacing: { after: 400 }
                }),
                new Paragraph({ 
                    text: `قطاع رقم (${absenceData[0]?.sector || ""})`,
                    alignment: AlignmentType.CENTER,
                    bidirectional: true,
                    spacing: { after: 400 }
                }),
                new Table({
                    rows: [tableHeaderRow, ...tableRows],
                    width: { size: 100, type: WidthType.PERCENTAGE },
                    margins: {
                        top: 100,
                        bottom: 100,
                        left: 100,
                        right: 100,
                    }
                })
            ]
        }]
    });

    Packer.toBlob(doc).then(blob => {
        saveAs(blob, `قائمة_الغيابات_${new Date().toISOString().split('T')[0]}.docx`);
    });
});

// 3. Export PDF (Modified - Separated Class and Date, Added Hall)
exportAbsentPdfBtn.addEventListener('click', async () => {
    const amiriFont = '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QIfAiECIwIlAicCKQIrAi0CLwIxAjMCNQI3AjkCOwI9Aj8CQQJDAkUCRwJJAksCTQJPAlECUwJVAlcCWQJbAl0CXwJhAmMCZQJnAmkCawJtAm8CcQJzAnUCdwJ5AnsCfQJ/AoECgwKFAocCiQKLAo0CjwKRApMClQKXApkCmwKdAp8CoQKjAqUCpwKpAqsCrQKvArECswK1ArcCuQK7Ar0CvwLBAsMCxQLHAskCzALOAtAC0gLUAtYC2ALaAtwC3gLgAuIC5ALmAugC6gLsAu4C8ALyAvQC9gL4AvoC/AL+AwADAgMEAwYDCAMKAwwDDgMQAxIDFAMWAxgDGgMcAx4DIAMiAyQDJgMoAyoDLAMuAzADMgM0AzYDOAM6AzwDPgNAA0IDRANGA0gDSgNMA04DUANWA1gDWgNcA14DYANlA2cDaQNrA20DbwNxA3MDdQN3A3kDewN9A38DgQODA4UDhwOJA4sDjQOPA5EDkwOVA5cDmQObA50DnwOhA6MDpQOnA6kDqwOtA68DsQOzA7UDtwO5A7sDvQO/A8EDwwPFA8cDyQPLA80DzwPRA9MD1QPXA9kD2wPdA98D4QPjA+UD5wPpA+sD7QPvA/ED8wP1A/cD+QP7A/0D/wQBBAIEBAQHBAkECwQNBA8EEQQTBBUEFwQZBBsEHQQfBCEEIwQlBCcEKQQrBC0ELwQxBDMENQQ3BDkEOwQ9BD8EQQRDBEUERwRJBEwETgRQBFIEVARWBFgEWgRcBF4EYARiBGQEZgRoBGoEbARuBHAEcgR0BHYEeAR6BHwEfgSABIIEhASGBIgEigSMBI4EkASSBJQElgSYBJoEnASeBKAEogSkBKYEqASqBKwErgSwBLIEtAS2BLgEugS8BL4EwATCBMSAAQABAAAABQADAAQABQAGAAcACAAJAAoACwAMAA0ADgAPABAAEQASABMAFAAVABYAFwAYABkAGgAbABwAHQAeAB8AIAAhACIAIwAkACUAJgAnACgAKQAqACsALAAtAC4ALwAwADEAMgAzADQANQA2ADcAOAA5ADoAOwA8AD0APgA/AEAAQQBCAEMARABFAEYARwBIAEkASgBLAEwATQBOAE8AUABRAFIAUwBUAFUAVgBXAFgAWQBaAFsAXABdAF4AXwBgAGEAYgBjAGQAZQBmAGcAaABpAGoAawBsAG0AbgBvAHAAcQByAHMAdAB1AHYAdwB4AHkAegB7AHwAfQB+AH8AgACBAIIAgwCEAIUAhgCHAIgAiQCKAIsAjACNAI4AjwCQAJEAkgCTAJQAlQCWAJcAmACZAJoAmwCcAJ0AngCfAKAAoQCiAKMApAClAKYApwCoAKkAqgCrAKwArQCuAK8AsACxALIAswC0ALUAtgC3ALgAuQC6ALsAvAC9AL4AvwDAAMEAwgDDAMQAxQDGAMcAyADJAMoAywDMAM0AzgDPANAA0QDSANMA1ADVANYA1wDYANkA2gDbANwA3QDeAN8A4ADhAOIA4wDkAOUA5gDnAOgA6QDqAOsA7ADtAO4A7wDwAPEA8gDzAPQA9QD2APcA+AD5APoA+wD8AP0A/gD/AQABAQECAQMBBAEFAQYBBwEIAQkBCgELAQwBDQEOAQ8BEAERARIBEwEUARUBFgEXARgBGQEaARsBHAEdAR4BHwEgASEBIgEjASQBJQEmAScBKAEpASoBKwEsAS0BLgEvATABMQEyATMBNAE1ATYBNwE4ATkBOgE7ATwBPQE+AT8BQAFBAUIBQwFEAUUBRgFHAUgBSQFKAUsBTAFNAU4BTwFQAVEBUgFTAVQBVQFVAVYBWAFaAVwBXgFgAWIBZAFmAWgBagFsAW4BcAFyAXQBdgF4AXoBfAF+AYABggGEAYYBiAGKAYwBjgGQAZIBlAGWAZgBmgGcAZ4BoAGiAaQBpgGoAaoBrAGuAbABsgG0AbYBuAG6AbwBvgHAAcIBxAHGAcgBygHMAc4B0AHSAdQB1gHYAdoB3AHeAeAB4gHkAeYB6AHqAewB7gHwAfIB9AH2AfgB+gH8Af4CAAICAgQCBgIIAgoCDAIOAhACEgIUAhYCGAIfAiMCJwIrAi8CMwI3AjsCPwJDAkcCSwJPAlMCVwJbAl8CYwJnAmsCbwJzAncCewJ/AoMChwKLAo8CkwKXApsCnwKjAqcCqwKvArMCtwK7Ar8CwwLHAssCzwLTAtsC4wLnAusC7wLzAvcC+wL/AwMDBwMLAw8DEwMfAycDLwM3Az8DRwNPA1cDXwNnA28DdwN/A4cDjwOXA58DpwOvA7cDvwPHA88D1wPfA+cD7wP3A/8EBwQPBBcEHwQnBC8ENwQ/BEcETwRXBF8EZwRvBHcEfwSHBI8ElwSfBKcErwS3BL8ExwTPBNcE3wTnBO8E9wT/BQcFDwUXBR8FJwUvBTcFPwVHBU8FVwVfBWcFbwV3BX8FhwWPBZcFnwWnBa8FtwW/BccFzwXXBd8F5wXvBfcF/wYHBg8GFwYfBicGLwY3Bj8GRwZPBlcGXwZnBm8GdwZ/BocGjwaXBp8GpwavBrcGvwbHBs8G1wbfBucG7wb3Bv8HBwcPBxcHHwcnBy8HNwc/B0cHTwdXB18HZwdvB3cHfweHB48HlwefB6cHrwe3B78HxwfPB9cH3wfnB+8H9wf/CAcIDwgXCB8IJwgvCDcIPwhHCE8IVwhfCGcIbwh3CH8IhwiPCJcInwinCK8Itwi/CMcIzwjXCN8I5wjvCPcI/wkHCRcJHwknCS8JNwk/CUcJTwlXCV8JZwlwCXcJgAmJCZAJlwmeCakJtQm+CcUJzgnVCeIJ5wn2CgUKDgoZCiYKMQo2Cj8KSgpVCloKZQpuCnkKhAqRCqAKrwq+CtIK4ArvCv4LDQsbCyoLOwtJC1YLaAtyC38LjwuZC6cLtAvBC88L3AvpC/UL/gwLDBYMIwwpDDIMPgxMDFkMbAx4DIkMlgyjDLEMvgzJDNIM3AzqDPMM/g0KDRQNJQ0xDTsNSA1VDWQNbw16DYUNjg2WDaMNrg26DcYNzg3cDeQN7A3yDfoOAA4GDgwOEg4YDh4OIA4iDiQOKA4sDjQOOA5ADkQOSA5MDlAOVA5YDlwOYA5kDmgObA5wDnQOeA58DoAOhA6IDowOkA6UDpgOnA6gDqQOqA6sDrAOtA64DrwOwA7EDsgOzA7QDtQO2A7cDuAO5A7oDuwO8A70DvgO/A8ADwQPCA8MDxAPFA8YDxwPIA8kDygPLA8wDzQPOBF4='; // نفس الخط الموجود في الكود
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.addFileToVFS('Amiri-Regular.ttf', amiriFont);
    doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
    doc.setFont('Amiri');
    doc.setR2L(true);

    const absenceData = getAbsenceDataForExport();
    
    // نغير رأس الجدول ليشمل الأعمدة الجديدة
    const head = [[
        'التوقيع', 
        'المراقب', 
        'رقمه', 
        'القاعة الامتحانية', 
        'الشعبة', 
        'الصف', 
        'التاريخ', 
        'اسم الطالب الغائب'
    ]];
    
    const body = absenceData.map(d => [
        '', // التوقيع
        '', // المراقب
        d.id,
        d.hall || "غير موزع", // القاعة الامتحانية
        d.section,
        d.class, // الصف (منفصل)
        d.date, // التاريخ (منفصل)
        d.name
    ]);

    // عنوان التقرير
    doc.setFontSize(16);
    doc.text("قائمة غيابات الطلبة", doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(`قطاع رقم (${absenceData[0]?.sector || ""})`, doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' });
    
    doc.autoTable({
        head: head,
        body: body,
        startY: 35,
        theme: 'grid',
        styles: {
            font: 'Amiri',
            fontSize: 10,
            halign: 'center',
            valign: 'middle',
            lineWidth: 0.1,
            lineColor: [0, 0, 0],
            cellPadding: 3
        },
        headStyles: {
            fillColor: [240, 240, 240],
            textColor: [0, 0, 0],
            fontStyle: 'bold',
            lineWidth: 0.1
        },
        columnStyles: {
            0: { cellWidth: 15 }, // التوقيع
            1: { cellWidth: 15 }, // المراقب
            2: { cellWidth: 12 }, // الرقم
            3: { cellWidth: 25 }, // القاعة الامتحانية
            4: { cellWidth: 12 }, // الشعبة
            5: { cellWidth: 12 }, // الصف
            6: { cellWidth: 20 }, // التاريخ
            7: { cellWidth: 30 }  // اسم الطالب
        },
        margin: { top: 35, right: 10, bottom: 10, left: 10 }
    });

    // إضافة تاريخ التصدير في أسفل الصفحة
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(
            `تم التصدير بتاريخ: ${new Date().toLocaleDateString('ar-EG')}`,
            doc.internal.pageSize.getWidth() - 10,
            doc.internal.pageSize.getHeight() - 10,
            { align: 'left' }
        );
    }

    doc.save(`قائمة_الغيابات_${new Date().toISOString().split('T')[0]}.pdf`);
});
